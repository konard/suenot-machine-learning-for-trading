# Matching Networks для трейдинга - Простое объяснение

## О чём это вообще? (Самое простое объяснение)

Представь, что ты **детектив**, который пытается идентифицировать преступников по фотографиям:

**Метод 1 - Прототипные сети (Метод "Среднего"):**
Ты создаёшь "усреднённое" фото каждого типа преступника, смешивая фото вместе.
Затем сравниваешь новых подозреваемых с этими усреднёнными фото.

**Метод 2 - Matching Networks (Метод "Опознания"):**
Ты выкладываешь ВСЕ фотографии в ряд и спрашиваешь: "На какие фото этот подозреваемый больше всего похож?"
Затем голосуешь на основе того, насколько подозреваемый похож на КАЖДОЕ фото.

**Matching Networks используют Метод 2** - и это работает лучше, когда преступники не все похожи друг на друга!

### Пример в трейдинге

```
Ты хочешь узнать: "Рынок вот-вот рухнет?"

Прототипные сети:
1. Берём все прошлые обвалы, смешиваем в ОДНУ "усреднённую картинку обвала"
2. Сравниваем сегодняшний рынок с этим средним
3. Проблема: Не все обвалы выглядят одинаково!

Matching Networks:
1. Храним ВСЕ примеры прошлых обвалов в памяти
2. Сравниваем сегодняшний рынок с КАЖДЫМ прошлым обвалом
3. Смотрим, на какие конкретные обвалы сегодняшний рынок больше всего похож
4. Принимаем решение на основе ближайших совпадений

Лучше! Теперь мы можем распознавать разные ТИПЫ обвалов!
```

---

## Разберём по шагам

### Шаг 1: Проблема с усреднением

Представь, что ты пытаешься определить "пиццу" по картинкам:

```
Твои примеры пиццы:
   [Маргарита]     [Пепперони]     [Гавайская]     [Кальцоне]
       🍕              🍕              🍕             🥟

Если УСРЕДНИТЬ их в ОДНУ "типичную пиццу"...
Получишь РАЗМЫТОЕ месиво, которое не похоже ни на одну настоящую пиццу!

ПРОТОТИПНЫЙ ПОДХОД:
┌─────────────────────────────────────────┐
│   Усредняем все пиццы → [Размытое месиво]│
│   Сравниваем новую еду с размытием      │
│   Проблема: Кальцоне это пицца? Сложно! │
└─────────────────────────────────────────┘

MATCHING ПОДХОД:
┌─────────────────────────────────────────┐
│   Храним ВСЕ примеры пицц              │
│   Сравниваем новую еду с КАЖДЫМ:        │
│     - 30% похоже на Маргариту           │
│     - 20% похоже на Пепперони           │
│     - 10% похоже на Гавайскую           │
│     - 40% похоже на Кальцоне ← Ближе!   │
│   Вердикт: Скорее всего кальцоне/пицца  │
└─────────────────────────────────────────┘
```

### Шаг 2: Как работают Matching Networks

Думай об этом как о **системе голосования на шоу талантов**:

```
АНАЛОГИЯ С ШОУ ТАЛАНТОВ

Ты судья, который решает: новый певец в стиле "Поп" или "Рок"?

SUPPORT SET (Твои эталонные исполнители):
┌─────────────────────────────────────────────────────────────┐
│ Поп примеры:            Рок примеры:                         │
│ 🎤 Тейлор Свифт         🎸 Metallica                         │
│ 🎤 Ариана Гранде        🎸 AC/DC                             │
│ 🎤 Эд Ширан             🎸 Queen                             │
│ 🎤 Дуа Липа             🎸 Led Zeppelin                      │
│ 🎤 The Weeknd           🎸 Nirvana                           │
└─────────────────────────────────────────────────────────────┘

НОВЫЙ ИСПОЛНИТЕЛЬ: Леди Гага

ПРОЦЕСС MATCHING NETWORKS:
1. Слушаем Леди Гагу
2. Сравниваем её звучание с КАЖДЫМ эталоном:
   - Тейлор Свифт: 70% похоже
   - Ариана Гранде: 80% похоже  ← Высокое совпадение!
   - Эд Ширан: 40% похоже
   - Metallica: 20% похоже
   - Queen: 45% похоже          ← Есть рок-влияние!
   - ...и т.д.

3. Эти сходства становятся "весами внимания"

4. ГОЛОСУЕМ на основе весов:
   Голоса за Поп:  70% + 80% + 40% + ... = 2.4 очка
   Голоса за Рок:  20% + 45% + ... = 1.1 очка

5. ПРЕДСКАЗАНИЕ: Поп-исполнитель! (Больше голосов)

БОНУС: Мы также можем сказать:
"Она БОЛЬШЕ ВСЕГО похожа на Ариану Гранде (80%)"
- Это даёт интерпретируемость!
```

### Шаг 3: Что такое "Внимание" (Attention)?

**Внимание** - это просто измерение "насколько я должен обратить внимание на этот пример?"

```
ВНИМАНИЕ ОБЪЯСНЕНО:

Представь, что ты потерял ключи и ищешь их по дому.

Твой мозг даёт "оценки внимания" разным местам:

┌────────────────────────────────────────────────────────┐
│ Место               │ Оценка внимания │ Почему?        │
├─────────────────────┼─────────────────┼────────────────┤
│ Карман пальто       │ 0.40 (40%)      │ Обычно там     │
│ Кухонная стойка     │ 0.30 (30%)      │ Частое место   │
│ Спальня             │ 0.20 (20%)      │ Иногда         │
│ Ванная              │ 0.08 (8%)       │ Редко          │
│ Гараж               │ 0.02 (2%)       │ Почти никогда  │
└────────────────────────────────────────────────────────┘
Всего: 100% (все оценки в сумме дают 1)

Именно так работают Matching Networks!
Они дают "оценки внимания" каждому примеру из support set.
```

### Шаг 4: Особый ингредиент - Полноконтекстные эмбеддинги (FCE)

Вот действительно умная часть. Представь, что ты на вечеринке пытаешься узнать кого-то:

```
БЕЗ КОНТЕКСТА (Простой Matching):
┌─────────────────────────────────────────────────────┐
│ Ты видишь: Высокий человек в костюме                │
│                                                     │
│ Твой мозг думает: "Похож на бизнесмена"            │
│                                                     │
│ Проблема: Может быть официант, охранник и т.д.     │
└─────────────────────────────────────────────────────┘

С КОНТЕКСТОМ (FCE):
┌─────────────────────────────────────────────────────┐
│ Ты видишь: Высокий человек в костюме                │
│ ПЛЮС замечаешь: Мы на свадьбе                       │
│ И видишь: Он стоит рядом с невестой                 │
│                                                     │
│ Твой мозг думает: "Это жених!"                      │
│                                                     │
│ Контекст полностью меняет интерпретацию!            │
└─────────────────────────────────────────────────────┘
```

**FCE в Matching Networks:**

```
КОНТЕКСТ SUPPORT SET:
До: Каждый пример кодируется отдельно
После: Каждый пример "знает о" других примерах

Пример в трейдинге:
┌─────────────────────────────────────────────────────┐
│ Support Set: 5 примеров паттернов "обвала"          │
│                                                     │
│ БЕЗ FCE:                                            │
│   Обвал 1: [признаки] → эмбеддинг_1                │
│   Обвал 2: [признаки] → эмбеддинг_2                │
│   Обвал 3: [признаки] → эмбеддинг_3                │
│   Каждый кодируется независимо                     │
│                                                     │
│ С FCE:                                              │
│   Все 5 обвалов обрабатываются вместе через LSTM   │
│   Обвал 1 "знает", что он отличается от обвалов 2-5│
│   Это делает представление богаче!                 │
└─────────────────────────────────────────────────────┘
```

---

## Аналогия из жизни: Диагноз врача

Представь, что ты врач, который ставит диагноз пациенту:

### Твоё медицинское обучение (Support Set)

Ты изучил **5 случаев каждой болезни**:

```
ГРИПП (5 случаев):
🤒 Случай 1: Температура, кашель, усталость
🤒 Случай 2: Температура, насморк, головная боль
🤒 Случай 3: Высокая температура, ломота в теле
🤒 Случай 4: Лёгкая температура, кашель, боль в горле
🤒 Случай 5: Температура, озноб, утомляемость

КОВИД (5 случаев):
😷 Случай 1: Температура, сухой кашель, потеря вкуса
😷 Случай 2: Температура, усталость, проблемы с дыханием
😷 Случай 3: Потеря обоняния, лёгкий кашель
😷 Случай 4: Температура, кашель, нет вкуса
😷 Случай 5: Головная боль, ломота, нет обоняния

ПРОСТУДА (5 случаев):
🤧 Случай 1: Насморк, чихание
🤧 Случай 2: Лёгкий кашель, насморк
🤧 Случай 3: Чихание, боль в горле
🤧 Случай 4: Заложенность, лёгкая усталость
🤧 Случай 5: Насморк, головная боль
```

### Диагностика Matching Networks

Приходит новый пациент с: **Температура, сухой кашель, потерял вкус**

```
ПРОЦЕСС MATCHING:

Шаг 1: Сравниваем со ВСЕМИ 15 случаями:

Случаи ГРИППА:
  Случай 1 (температура, кашель, усталость):    Сходство = 50%
  Случай 2 (температура, насморк):              Сходство = 30%
  Случай 3 (высокая температура, ломота):       Сходство = 35%
  Случай 4 (температура, кашель, горло):        Сходство = 45%
  Случай 5 (температура, озноб):                Сходство = 40%

Случаи КОВИДА:
  Случай 1 (температура, сухой кашель, вкус):   Сходство = 95% ← ОЧЕНЬ ВЫСОКО!
  Случай 2 (температура, усталость, дыхание):   Сходство = 55%
  Случай 3 (нет обоняния, лёгкий кашель):      Сходство = 60%
  Случай 4 (температура, кашель, нет вкуса):    Сходство = 90% ← ОЧЕНЬ ВЫСОКО!
  Случай 5 (головная боль, нет обоняния):      Сходство = 45%

Случаи ПРОСТУДЫ:
  Случай 1 (насморк, чихание):                 Сходство = 10%
  Случай 2 (лёгкий кашель, насморк):           Сходство = 15%
  Случай 3 (чихание, боль в горле):            Сходство = 5%
  Случай 4 (заложенность, усталость):          Сходство = 15%
  Случай 5 (насморк, головная боль):           Сходство = 10%

Шаг 2: Преобразуем в веса внимания (нормализуем к сумме = 1)

Шаг 3: Голосуем по болезням:
  ГРИПП всего:    2.0% + 1.5% + 1.7% + 2.2% + 2.0% = 9.4%
  КОВИД всего:    15.5% + 8.9% + 9.7% + 14.6% + 7.3% = 56.0%
  ПРОСТУДА всего: 1.6% + 2.4% + 0.8% + 2.4% + 1.6% = 8.8%

Шаг 4: ДИАГНОЗ = КОВИД (56% вероятность)

БОНУС ИНФОРМАЦИЯ:
"Пациент больше всего похож на случай Ковида 1 (95%) и Случай 4 (90%)"
Это помогает объяснить ПОЧЕМУ мы поставили этот диагноз!
```

---

## Применение в трейдинге: Распознавание паттернов

### Торговый сценарий

```
Ты хочешь предсказать: "Что произойдёт дальше на рынке?"

ТВОЙ SUPPORT SET (Прошлые рыночные паттерны):

Паттерны ПРОБОЯ (5 примеров):
📈 Пример 1: Цена пробила сопротивление, объём взлетел
📈 Пример 2: Пробой треугольника, огромный объём
📈 Пример 3: Выход из диапазона после консолидации
📈 Пример 4: Пробой на новостях
📈 Пример 5: Гэп на открытии с пробоем

Паттерны РАЗВОРОТА (5 примеров):
📉 Пример 1: Двойная вершина, дивергенция RSI
📉 Пример 2: Голова и плечи, снижение объёма
📉 Пример 3: Гэп истощения, затем распродажа
📉 Пример 4: Ложный пробой, ловушка для трейдеров
📉 Пример 5: Взрыв вершины, экстремальный объём

Паттерны ПРОДОЛЖЕНИЯ (5 примеров):
➡️ Пример 1: Паттерн флага, тренд продолжается
➡️ Пример 2: Откат к поддержке, отскок
➡️ Пример 3: Тест скользящей средней, удержание
➡️ Пример 4: Консолидация на низком объёме, затем продолжение
➡️ Пример 5: Возможность покупки на спаде

СЕГОДНЯШНИЙ РЫНОК: Цена только что обновила максимум, объём падает...
```

### Анализ Matching Networks

```
ПРОЦЕСС MATCHING:

Признаки сегодняшнего рынка:
- Новый исторический максимум
- Снижающийся объём на росте
- RSI показывает дивергенцию (цена вверх, RSI вниз)
- Некоторые признаки истощения покупателей

Сравниваем со ВСЕМИ примерами support:

Примеры ПРОБОЯ:
  Пример 1: 40% похоже (новый хай да, но объём падает)
  Пример 2: 30% похоже (нет чёткого треугольника)
  Пример 3: 35% похоже (какой-то выход из консолидации)
  Пример 4: 25% похоже (нет важных новостей)
  Пример 5: 20% похоже (не гэп)

Примеры РАЗВОРОТА:
  Пример 1: 85% похоже (дивергенция RSI совпадает!) ← ВЫСОКО!
  Пример 2: 45% похоже (не совсем Г&П)
  Пример 3: 60% похоже (есть признаки истощения)
  Пример 4: 55% похоже (может быть ловушка)
  Пример 5: 70% похоже (возможные признаки взрыва!) ← ЗАМЕТНО!

Примеры ПРОДОЛЖЕНИЯ:
  Пример 1: 30% похоже (не флаг)
  Пример 2: 40% похоже (нет чёткого отката)
  Пример 3: 35% похоже (МА не тестировалась)
  Пример 4: 45% похоже (объём низкий, но...)
  Пример 5: 35% похоже (не чёткий спад)

ГОЛОСОВАНИЕ:
  ПРОБОЙ:       1.5% общего внимания
  РАЗВОРОТ:     3.2% общего внимания ← НАИВЫСШЕЕ
  ПРОДОЛЖЕНИЕ:  1.9% общего внимания

ПРЕДСКАЗАНИЕ: Вероятен паттерн РАЗВОРОТА (наивысшее внимание)

ИНТЕРПРЕТАЦИЯ:
"Этот рынок больше всего похож на:
 - Разворот Пример 1 (дивергенция RSI) - 85% совпадение
 - Разворот Пример 5 (взрыв вершины) - 70% совпадение"

ТОРГОВОЕ ДЕЙСТВИЕ: Будь осторожен, рассмотри фиксацию прибыли, следи за подтверждением
```

---

## Почему Matching Networks лучше для определённых задач

```
┌───────────────────────────────────────────────────────────────────────┐
│              КОГДА ИСПОЛЬЗОВАТЬ MATCHING NETWORKS                     │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│   ИСПОЛЬЗУЙ MATCHING NETWORKS КОГДА:                                  │
│                                                                       │
│   1. Категории РАЗНООБРАЗНЫ                                          │
│      ┌─────────────────────────────────────────────────┐             │
│      │ "Обвал" может выглядеть по-разному:             │             │
│      │  - Флэш-крэш (внезапный)                        │             │
│      │  - Медленное снижение (постепенное)             │             │
│      │  - Паническая распродажа (всплеск объёма)      │             │
│      │  - Тихое падение (низкий объём)                 │             │
│      │                                                 │             │
│      │ Усреднение этого = бессмысленное пятно          │             │
│      │ Хранить отдельно = полезно!                     │             │
│      └─────────────────────────────────────────────────┘             │
│                                                                       │
│   2. Тебе нужна ИНТЕРПРЕТИРУЕМОСТЬ                                   │
│      ┌─────────────────────────────────────────────────┐             │
│      │ Прототипные: "Это на 73% похоже на обвал"       │             │
│      │ (по сравнению с абстрактным средним)            │             │
│      │                                                 │             │
│      │ Matching: "Это на 85% похоже на                 │             │
│      │           обвал марта 2020 конкретно"           │             │
│      │ (по сравнению с реальным примером)              │             │
│      │                                                 │             │
│      │ Гораздо более actionable!                       │             │
│      └─────────────────────────────────────────────────┘             │
│                                                                       │
│   3. КОНТЕКСТ имеет значение                                         │
│      ┌─────────────────────────────────────────────────┐             │
│      │ Один паттерн может значить разное:              │             │
│      │                                                 │             │
│      │ "Цена пробивает сопротивление"                  │             │
│      │  - На бычьем рынке = Бычий пробой              │             │
│      │  - После долгого ралли = Возможный blow-off top│             │
│      │  - На низком объёме = Ложный пробой            │             │
│      │                                                 │             │
│      │ FCE в Matching Networks улавливает это!         │             │
│      └─────────────────────────────────────────────────┘             │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

---

## Простой пример кода (псевдокод)

```python
# Шаг 1: Собираем support примеры
support_set = [
    ("признаки паттерна пробоя", "пробой"),
    ("признаки паттерна разворота", "разворот"),
    ("признаки паттерна продолжения", "продолжение"),
    # ... 5 примеров каждого
]

# Шаг 2: Когда приходят новые рыночные данные
today_market = extract_features(current_price_data)

# Шаг 3: Сравниваем со ВСЕМИ support примерами
attention_scores = []
for support_features, support_label in support_set:
    similarity = calculate_similarity(today_market, support_features)
    attention_scores.append((similarity, support_label))

# Шаг 4: Преобразуем в проценты (softmax)
total = sum(score for score, _ in attention_scores)
attention_weights = [(score/total, label) for score, label in attention_scores]

# Шаг 5: Голосуем по классам
votes = {"пробой": 0, "разворот": 0, "продолжение": 0}
for weight, label in attention_weights:
    votes[label] += weight

# Шаг 6: Предсказание = класс с наибольшим количеством голосов
prediction = max(votes, key=votes.get)
confidence = votes[prediction]

print(f"Предсказание: {prediction}")
print(f"Уверенность: {confidence:.1%}")
print(f"Топ совпадения: {sorted(attention_weights, reverse=True)[:3]}")
```

---

## Резюме: Matching Networks на одной картинке

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    РЕЗЮМЕ MATCHING NETWORKS                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ВХОД: Новые рыночные данные (query)                                   │
│         Support set размеченных примеров                                 │
│                                                                          │
│   ПРОЦЕСС:                                                               │
│   ┌──────────────────────────────────────────────────────────────┐      │
│   │                                                              │      │
│   │   Query: [Сегодняшний рынок] ───────────────────────────┐   │      │
│   │                                                         │   │      │
│   │   Support Set:                                          ▼   │      │
│   │   ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐     ┌────────┐│      │
│   │   │ Пр1 │  │ Пр2 │  │ Пр3 │  │ Пр4 │  │ Пр5 │ ... │ВНИМАНИЕ││      │
│   │   └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘     └────┬───┘│      │
│   │      │        │        │        │        │              │    │      │
│   │      ▼        ▼        ▼        ▼        ▼              ▼    │      │
│   │    [.15]    [.05]    [.40]    [.30]    [.10]    = 1.0 всего │      │
│   │                                                              │      │
│   │   Класс A: Пр1, Пр3        → 0.15 + 0.40 = 0.55            │      │
│   │   Класс B: Пр2, Пр4, Пр5   → 0.05 + 0.30 + 0.10 = 0.45     │      │
│   │                                                              │      │
│   └──────────────────────────────────────────────────────────────┘      │
│                                                                          │
│   ВЫХОД:                                                                │
│   - Предсказание: Класс A (55%)                                         │
│   - Наиболее похож: Пример 3 (40% внимания)                            │
│   - Интерпретируемо: "Больше всего похоже на Пример 3"                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Ключевые выводы

1. **Matching Networks сравнивают со ВСЕМИ примерами**, а не только со средним
2. **Веса внимания** показывают какие примеры важнее всего
3. **Полноконтекстные эмбеддинги (FCE)** позволяют примерам "знать о" друг друге
4. **Более интерпретируемо** чем прототипные сети - ты знаешь какие конкретные примеры совпали
5. **Отлично для трейдинга** потому что рыночные паттерны могут быть очень разнообразными
6. **Работает с малым числом примеров** - нужно всего 5-10 примеров на паттерн!

---

## Попробуй сам!

В следующий раз когда смотришь на график, попробуй:
1. Храни "библиотеку" из 5 примеров каждого типа паттерна, который тебя интересует
2. Когда видишь новый паттерн, сравни его с КАЖДЫМ примером в твоей библиотеке
3. На какие примеры он больше всего похож?
4. Какая категория паттернов побеждает в "голосовании"?

Поздравляю! Ты только что сделал Matching Networks в своей голове!

# Оптимизация портфеля и оценка эффективности

Чтобы протестировать стратегию перед её реализацией в рыночных условиях, нам необходимо симулировать сделки, которые совершил бы алгоритм, и проверить их эффективность. Оценка стратегии включает бэктестинг на исторических данных для оптимизации параметров стратегии и форвард-тестинг для валидации внутривыборочной эффективности на новых, вне-выборочных данных. Цель состоит в том, чтобы избежать ложных открытий от подгонки стратегии под конкретные прошлые обстоятельства.

В контексте портфеля положительная доходность активов может компенсировать отрицательные движения цен. Положительные изменения цен одного актива с большей вероятностью компенсируют убытки по другому, чем ниже корреляция между двумя позициями. Основываясь на том, как риск портфеля зависит от ковариации позиций, Гарри Марковиц разработал теорию современного управления портфелем, основанную на диверсификации, в 1952 году. Результатом является оптимизация среднего-дисперсии, которая выбирает веса для данного набора активов для минимизации риска, измеряемого как стандартное отклонение доходности для заданной ожидаемой доходности.

Модель оценки капитальных активов (CAPM) вводит премию за риск, измеряемую как ожидаемая доходность сверх безрисковой инвестиции, в качестве равновесного вознаграждения за владение активом. Это вознаграждение компенсирует подверженность одному фактору риска — рынку — который является систематическим в отличие от идиосинкратического для актива и, следовательно, не может быть диверсифицирован.

Управление рисками эволюционировало, становясь более сложным по мере появления дополнительных факторов риска и более детальных вариантов экспозиции. Критерий Келли является популярным подходом к динамической оптимизации портфеля, который представляет собой выбор последовательности позиций во времени; он был знаменито адаптирован из своего первоначального применения в азартных играх к фондовому рынку Эдвардом Торпом в 1968 году.

В результате существует несколько подходов к оптимизации портфелей, которые включают применение машинного обучения (ML) для изучения иерархических отношений между активами и рассмотрения их владений как дополнений или заменителей по отношению к профилю риска портфеля. Эта глава охватывает следующие темы:

## Содержание

1. [Как измерять эффективность портфеля](#как-измерять-эффективность-портфеля)
    * [Коэффициент Шарпа (скорректированный)](#коэффициент-шарпа-скорректированный)
    * [Фундаментальный закон активного управления](#фундаментальный-закон-активного-управления)
2. [Как управлять риском и доходностью портфеля](#как-управлять-риском-и-доходностью-портфеля)
    * [Эволюция современного управления портфелем](#эволюция-современного-управления-портфелем)
    * [Оптимизация среднего-дисперсии](#оптимизация-среднего-дисперсии)
        - [Примеры кода: Нахождение эффективной границы в Python](#примеры-кода-нахождение-эффективной-границы-в-python)
    * [Альтернативы оптимизации среднего-дисперсии](#альтернативы-оптимизации-среднего-дисперсии)
        - [Портфель 1/N](#портфель-1n)
        - [Портфель минимальной дисперсии](#портфель-минимальной-дисперсии)
        - [Подход Блэка-Литтермана](#подход-блэка-литтермана)
        - [Как определить размер ставки – правило Келли](#как-определить-размер-ставки--правило-келли)
        - [Альтернативы MV оптимизации с Python](#альтернативы-mv-оптимизации-с-python)
    * [Иерархический паритет рисков](#иерархический-паритет-рисков)
3. [Торговля и управление портфелем с помощью `Zipline`](#торговля-и-управление-портфелем-с-помощью-zipline)
    * [Примеры кода: Бэктесты со сделками и оптимизацией портфеля](#примеры-кода-бэктесты-со-сделками-и-оптимизацией-портфеля)
4. [Измерение эффективности бэктеста с помощью `pyfolio`](#измерение-эффективности-бэктеста-с-помощью-pyfolio)
    * [Пример кода: оценка `pyfolio` из бэктеста `Zipline`](#пример-кода-оценка-pyfolio-из-бэктеста-zipline)

## Как измерять эффективность портфеля

Для оценки и сравнения различных стратегий или для улучшения существующей стратегии нам нужны метрики, которые отражают их эффективность в отношении наших целей. В инвестициях и торговле наиболее распространенными целями являются **доходность и риск инвестиционного портфеля**.

Цели доходности и риска подразумевают компромисс: принятие большего риска может принести более высокую доходность в некоторых обстоятельствах, но также подразумевает больший недостаток. Для сравнения того, как различные стратегии справляются с этим компромиссом, очень популярны коэффициенты, которые вычисляют меру доходности на единицу риска. Мы обсудим **коэффициент Шарпа** и **информационный коэффициент** (IR) по очереди.

### Коэффициент Шарпа (скорректированный)

Априорный коэффициент Шарпа (SR) сравнивает ожидаемую избыточную доходность портфеля с волатильностью этой избыточной доходности, измеряемой её стандартным отклонением. Он измеряет компенсацию как среднюю избыточную доходность на единицу принятого риска. Он может быть оценен на основе данных.

Финансовая доходность часто нарушает предположения iid. Эндрю Ло вывел необходимые корректировки распределения и временной агрегации для доходностей, которые стационарны, но автокоррелированы. Это важно, потому что временные свойства инвестиционных стратегий (например, возврат к среднему, моментум и другие формы серийной корреляции) могут иметь нетривиальное влияние на сам оценщик SR, особенно при аннуализации SR из данных более высокой частоты.

- [The Statistics of Sharpe Ratios](https://www.jstor.org/stable/4480405?seq=1#page_scan_tab_contents), Andrew Lo, Financial Analysts Journal, 2002

### Фундаментальный закон активного управления

Любопытный факт, что Renaissance Technologies (RenTec), фонд с лучшими показателями, основанный Джимом Саймонсом, которого мы упоминали в [Главе 1](../01_machine_learning_for_trading), производил аналогичную доходность, как Уоррен Баффет, несмотря на совершенно разные подходы. Инвестиционная фирма Уоррена Баффета Berkshire Hathaway держит около 100-150 акций в течение довольно длительных периодов, тогда как RenTec может выполнять 100,000 сделок в день. Как мы можем сравнить эти различные стратегии?

ML заключается в оптимизации целевых функций. В алгоритмической торговле целями являются доходность и риск общего инвестиционного портфеля, обычно относительно бенчмарка (которым могут быть денежные средства, безрисковая процентная ставка или индекс цен активов, такой как S&P 500).

Высокий информационный коэффициент (IR) подразумевает привлекательную избыточную доходность относительно принятого дополнительного риска. Фундаментальный закон активного управления разбивает IR на информационный коэффициент (IC) как меру навыков прогнозирования и способность применять этот навык через независимые ставки. Он резюмирует важность играть как часто (высокая широта), так и играть хорошо (высокий IC).

IC измеряет корреляцию между альфа-фактором и форвардными доходностями, вытекающими из его сигналов, и фиксирует точность навыков прогнозирования менеджера. Широта стратегии измеряется независимым количеством ставок, которые инвестор делает в данный период времени, и произведение обоих значений пропорционально IR, также известному как риск оценки (Treynor and Black).

Фундаментальный закон важен, потому что он подчеркивает ключевые факторы превосходства: важны как точные прогнозы, так и способность делать независимые прогнозы и действовать на основе этих прогнозов. На практике оценка широты стратегии сложна из-за кросс-секционной и временной корреляции между прогнозами.

- [Active Portfolio Management: A Quantitative Approach for Producing Superior Returns and Controlling Risk](https://www.amazon.com/Active-Portfolio-Management-Quantitative-Controlling/dp/0070248826) by Richard Grinold and Ronald Kahn, 1999
- [How to Use Security Analysis to Improve Portfolio Selection](https://econpapers.repec.org/article/ucpjnlbus/v_3a46_3ay_3a1973_3ai_3a1_3ap_3a66-86.htm), Jack L Treynor and Fischer Black, Journal of Business, 1973
- [Portfolio Constraints and the Fundamental Law of Active Management](https://faculty.fuqua.duke.edu/~charvey/Teaching/BA491_2005/Transfer_coefficient.pdf), Clarke et al 2002

## Как управлять риском и доходностью портфеля

Управление портфелем нацелено на выбор и определение размера позиций в финансовых инструментах, которые достигают желаемого компромисса риск-доходность относительно бенчмарка. Как управляющий портфелем, в каждый период вы выбираете позиции, которые оптимизируют диверсификацию для снижения рисков при достижении целевой доходности. В разные периоды эти позиции могут требовать ребалансировки для учета изменений в весах, вызванных движениями цен, для достижения или поддержания целевого профиля риска.

### Эволюция современного управления портфелем

Диверсификация позволяет нам снизить риски для данной ожидаемой доходности, используя то, как несовершенная корреляция позволяет прибыли одного актива компенсировать убытки другого актива. Гарри Марковиц изобрел современную теорию портфеля (MPT) в 1952 году и предоставил математические инструменты для оптимизации диверсификации путем выбора соответствующих весов портфеля.

### Оптимизация среднего-дисперсии

Современная теория портфеля решает задачу оптимальных весов портфеля для минимизации волатильности для данной ожидаемой доходности или максимизации доходности для данного уровня волатильности. Ключевыми необходимыми входными данными являются ожидаемая доходность активов, стандартные отклонения и матрица ковариации.

- [Portfolio Selection](https://www.math.ust.hk/~maykwok/courses/ma362/07F/markowitz_JF.pdf), Harry Markowitz, The Journal of Finance, 1952
- [The Capital Asset Pricing Model: Theory and Evidence](http://mba.tuck.dartmouth.edu/bespeneckbo/default/AFA611-Eckbo%20web%20site/AFA611-S6B-FamaFrench-CAPM-JEP04.pdf), Eugene F. Fama and Kenneth R. French, Journal of Economic Perspectives, 2004

#### Примеры кода: Нахождение эффективной границы в Python

Мы можем рассчитать эффективную границу, используя scipy.optimize.minimize и исторические оценки доходности активов, стандартных отклонений и матрицы ковариации.
- Ноутбук [mean_variance_optimization](04_mean_variance_optimization.ipynb) для вычисления эффективной границы в python.

### Альтернативы оптимизации среднего-дисперсии

Проблемы с точными входными данными для задачи оптимизации среднего-дисперсии привели к принятию нескольких практических альтернатив, которые ограничивают среднее, дисперсию или оба, или опускают оценки доходности, которые более сложны, такие как подход паритета рисков, который мы обсуждаем позже в этом разделе.

#### Портфель 1/N

Простые портфели предоставляют полезные бенчмарки для оценки добавленной стоимости сложных моделей, которые создают риск переобучения. Простейшая стратегия — равновзвешенный портфель — была показана как одна из лучших исполнителей.

#### Портфель минимальной дисперсии

Другой альтернативой является портфель глобальной минимальной дисперсии (GMV), который приоритизирует минимизацию риска. Он показан на рисунке эффективной границы и может быть рассчитан следующим образом путем минимизации стандартного отклонения портфеля с использованием структуры среднее-дисперсия.

#### Подход Блэка-Литтермана

Подход глобальной оптимизации портфеля Блэка и Литтермана (1992) сочетает экономические модели со статистическим обучением и популярен, потому что он генерирует оценки ожидаемой доходности, которые правдоподобны во многих ситуациях. Метод предполагает, что рынок является портфелем среднее-дисперсия, как подразумевается равновесной моделью CAPM. Он строится на факте, что наблюдаемая рыночная капитализация может рассматриваться как оптимальные веса, присвоенные каждой ценной бумаге рынком. Рыночные веса отражают рыночные цены, которые, в свою очередь, воплощают ожидания рынка относительно будущей доходности.

- [Global Portfolio Optimization](http://www.sef.hku.hk/tpg/econ6017/2011/black-litterman-1992.pdf), Black, Fischer; Litterman, Robert
Financial Analysts Journal, 1992

#### Как определить размер ставки – правило Келли

Правило Келли имеет долгую историю в азартных играх, потому что оно дает руководство о том, сколько ставить на каждую из (бесконечной) последовательности ставок с варьирующимися (но благоприятными) шансами для максимизации конечного богатства. Оно было опубликовано как "A New Interpretation of the Information Rate" в 1956 году Джоном Келли, который был коллегой Клода Шеннона в Bell Labs. Его заинтриговали ставки, размещенные на кандидатов в новом игровом шоу The $64,000 Question, где зритель на западном побережье использовал трехчасовую задержку для получения инсайдерской информации о победителях.

Келли провел связь с теорией информации Шеннона, чтобы решить задачу ставки, оптимальной для долгосрочного роста капитала, когда шансы благоприятны, но неопределенность остается. Его правило максимизирует логарифмическое богатство как функцию шансов на успех каждой игры и включает неявную защиту от банкротства, поскольку log(0) — отрицательная бесконечность, так что игрок Келли естественным образом избегает потери всего.

- [A New Interpretation of Information Rate](https://www.princeton.edu/~wbialek/rome/refs/kelly_56.pdf), John Kelly, 1956
- [Beat the Dealer: A Winning Strategy for the Game of Twenty-One](https://www.amazon.com/Beat-Dealer-Winning-Strategy-Twenty-One/dp/0394703103), Edward O. Thorp,1966
- [Beat the Market: A Scientific Stock Market System](https://www.researchgate.net/publication/275756748_Beat_the_Market_A_Scientific_Stock_Market_System), Edward O. Thorp,1967
- [Quantitative Trading: How to Build Your Own Algorithmic Trading Business](https://www.amazon.com/Quantitative-Trading-Build-Algorithmic-Business/dp/0470284889/ref=sr_1_2?s=books&ie=UTF8&qid=1545525861&sr=1-2), Ernie Chan, 2008

#### Альтернативы MV оптимизации с Python

- Ноутбук [kelly_rule](05_kelly_rule.ipynb) демонстрирует применение для случая одного и нескольких активов.
- Последний результат также включен в ноутбук [mean_variance_optimization](04_mean_variance_optimization.ipynb), наряду с несколькими другими альтернативными подходами.

### Иерархический паритет рисков

Этот новый подход, разработанный [Marcos Lopez de Prado](http://www.quantresearch.org/), нацелен на решение трех основных проблем квадратичных оптимизаторов в целом и алгоритма критической линии Марковица (CLA) в частности:
- нестабильность,
- концентрация, и
- недостаточная эффективность.

Иерархический паритет рисков (HRP) применяет теорию графов и машинное обучение для построения диверсифицированного портфеля на основе информации, содержащейся в матрице ковариации. Однако, в отличие от квадратичных оптимизаторов, HRP не требует обратимости матрицы ковариации. Фактически, HRP может вычислить портфель на плохо вырожденной или даже сингулярной матрице ковариации — невозможный подвиг для квадратичных оптимизаторов. Эксперименты Монте-Карло показывают, что HRP обеспечивает более низкую дисперсию вне выборки, чем CLA, даже несмотря на то, что минимальная дисперсия является целью оптимизации CLA. HRP также производит менее рискованные портфели вне выборки по сравнению с традиционными методами паритета рисков. Мы обсудим HRP более подробно в [Главе 13](../13_unsupervised_learning), когда будем обсуждать применение обучения без учителя, включая иерархическую кластеризацию, к торговле.

- [Building diversified portfolios that outperform out of sample](https://jpm.pm-research.com/content/42/4/59.short), Marcos López de Prado, The Journal of Portfolio Management 42, no. 4 (2016): 59-69.
- [Hierarchical Clustering Based Asset Allocation](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2840729), Thomas Raffinot, 2016

Мы демонстрируем, как реализовать HRP и сравнить его с альтернативами в Главе 13 об [Обучении без учителя](../13_unsupervised_learning), где мы также вводим иерархическую кластеризацию.

## Торговля и управление портфелем с помощью `Zipline`

Библиотека с открытым исходным кодом [zipline](https://zipline.ml4trading.io/index.html) является событийно-управляемой системой бэктестинга, поддерживаемой и используемой в производстве краудсорсинговым количественным инвестиционным фондом [Quantopian](https://www.quantopian.com/) для облегчения разработки алгоритмов и живой торговли. Она автоматизирует реакцию алгоритма на торговые события и предоставляет ему текущие и исторические данные на момент времени, которые избегают смещения look-ahead. [Глава 8 - Рабочий процесс ML4T](../08_strategy_workflow) имеет более подробное, специальное введение в бэктестинг с использованием как `zipline`, так и `backtrader`.

В [Главе 4](../04_alpha_factor_research) мы представили `zipline` для симуляции вычисления альфа-факторов из скользящих кросс-секционных рыночных, фундаментальных и альтернативных данных. Теперь мы будем использовать альфа-факторы для получения и действия на основе сигналов покупки и продажи.

### Примеры кода: Бэктесты со сделками и оптимизацией портфеля

Код для этого раздела находится в следующих двух ноутбуках:
- Ноутбуки в этом разделе используют окружение `conda` `backtest`. Пожалуйста, см. [инструкции](../installation/README.md) по установке для загрузки последнего образа Docker или альтернативные способы настройки вашего окружения.
- Ноутбук [backtest_with_trades](01_backtest_with_trades.ipynb) симулирует торговые решения, которые строят портфель на основе простого альфа-фактора MeanReversion из последней главы с использованием Zipline. Мы явно не оптимизируем веса портфеля и просто назначаем позиции равной стоимости каждому владению.
- Ноутбук [backtest_with_pf_optimization](02_backtest_with_pf_optimization.ipynb) демонстрирует, как использовать оптимизацию портфеля как часть простого бэктеста стратегии.

## Измерение эффективности бэктеста с помощью `pyfolio`

Pyfolio облегчает анализ эффективности и риска портфеля внутри выборки и вне выборки с использованием многих стандартных метрик. Он производит tear sheets, охватывающие анализ доходности, позиций и транзакций, а также событийного риска в периоды рыночного стресса с использованием нескольких встроенных сценариев, а также включает байесовский анализ эффективности вне выборки.

### Пример кода: оценка `pyfolio` из бэктеста `Zipline`

Ноутбук [pyfolio_demo](03_pyfolio_demo.ipynb) иллюстрирует, как извлечь входные данные `pyfolio` из бэктеста, проведенного в предыдущей папке. Затем он переходит к вычислению нескольких метрик эффективности и tear sheets с использованием `pyfolio`.

- Этот ноутбук требует окружения `conda` `backtest`. Пожалуйста, см. [инструкции по установке](../installation/README.md) для запуска последнего образа Docker или альтернативных способов настройки вашего окружения.

# От прогнозов волатильности к статистическому арбитражу: линейные модели временных рядов

В этой главе мы построим динамические линейные модели, которые явно учитывают время и включают переменные, наблюдаемые через определённые интервалы или с лагами. Ключевая характеристика данных временных рядов — их последовательный порядок: в отличие от случайных выборок отдельных наблюдений, как в случае кросс-секционных данных, наши данные представляют собой единственную реализацию стохастического процесса, который мы не можем повторить.

Наша цель — выявить **систематические паттерны во временных рядах**, которые помогут нам предсказать поведение временного ряда в будущем. Более конкретно, мы фокусируемся на моделях, которые извлекают сигналы из исторической последовательности выходных данных и, опционально, других одновременных или запаздывающих входных переменных для прогнозирования будущих значений. Например, мы можем попытаться предсказать будущую доходность акции, используя прошлые доходности в сочетании с историческими доходностями бенчмарка или макроэкономическими переменными. Мы сосредоточимся на линейных моделях временных рядов, прежде чем перейти к нелинейным моделям, таким как рекуррентные или свёрточные нейронные сети в Части 4.

Модели временных рядов очень популярны, учитывая временное измерение, присущее трейдингу. Ключевые применения включают **прогнозирование доходности и волатильности активов**, а также выявление совместных движений ценовых рядов активов. Данные временных рядов, вероятно, станут ещё более распространёнными по мере того, как всё более широкий спектр подключённых устройств собирает регулярные измерения с потенциальным сигнальным содержанием.

Сначала мы представим инструменты для диагностики характеристик временных рядов и извлечения признаков, которые захватывают потенциальные паттерны. Затем мы представим одномерные и многомерные модели временных рядов и применим их для прогнозирования макроданных и паттернов волатильности. В заключение мы рассмотрим концепцию **коинтеграции** и то, как применить её для разработки **стратегии парной торговли**.

## Содержание

1. [Инструменты для диагностики и извлечения признаков](#инструменты-для-диагностики-и-извлечения-признаков)
    * [Как разложить паттерны временных рядов](#как-разложить-паттерны-временных-рядов)
    * [Статистики скользящего окна и скользящие средние](#статистики-скользящего-окна-и-скользящие-средние)
    * [Как измерить автокорреляцию](#как-измерить-автокорреляцию)
    * [Как диагностировать и достичь стационарности](#как-диагностировать-и-достичь-стационарности)
    * [Как применять преобразования временных рядов](#как-применять-преобразования-временных-рядов)
    * [Как диагностировать и устранять единичные корни](#как-диагностировать-и-устранять-единичные-корни)
    * [Пример кода: работа с данными временных рядов](#пример-кода-работа-с-данными-временных-рядов)
    * [Ресурсы](#ресурсы)
2. [Одномерные модели временных рядов](#одномерные-модели-временных-рядов)
    * [Как строить авторегрессионные модели](#как-строить-авторегрессионные-модели)
    * [Как строить модели скользящего среднего](#как-строить-модели-скользящего-среднего)
    * [Как строить модели ARIMA и расширения](#как-строить-модели-arima-и-расширения)
    * [Пример кода: прогнозирование макроэкономических показателей с помощью моделей ARIMA и SARIMAX](#пример-кода-прогнозирование-макроэкономических-показателей-с-помощью-моделей-arima-и-sarimax)
    * [Как использовать модели временных рядов для прогнозирования волатильности](#как-использовать-модели-временных-рядов-для-прогнозирования-волатильности)
    * [Как построить модель прогнозирования волатильности](#как-построить-модель-прогнозирования-волатильности)
    * [Примеры кода: прогнозы волатильности](#примеры-кода-прогнозы-волатильности)
    * [Ресурсы](#ресурсы-2)
3. [Многомерные модели временных рядов](#многомерные-модели-временных-рядов)
    * [Векторная авторегрессионная модель (VAR)](#векторная-авторегрессионная-модель-var)
    * [Пример кода: как использовать модель VAR для прогнозирования макроэкономических показателей](#пример-кода-как-использовать-модель-var-для-прогнозирования-макроэкономических-показателей)
    * [Ресурсы](#ресурсы-3)
4. [Коинтеграция — временные ряды с общим трендом](#коинтеграция--временные-ряды-с-общим-трендом)
    * [Парная торговля: статистический арбитраж с коинтеграцией](#парная-торговля-статистический-арбитраж-с-коинтеграцией)
    * [Альтернативные подходы к выбору и торговле совместно движущимися активами](#альтернативные-подходы-к-выбору-и-торговле-совместно-движущимися-активами)
    * [Пример кода: парная торговля на практике](#пример-кода-парная-торговля-на-практике)
        - [Вычисление эвристик на основе расстояний для идентификации коинтегрированных пар](#вычисление-эвристик-на-основе-расстояний-для-идентификации-коинтегрированных-пар)
        - [Предварительное вычисление тестов на коинтеграцию](#предварительное-вычисление-тестов-на-коинтеграцию)
    * [Ресурсы](#ресурсы-4)

## Инструменты для диагностики и извлечения признаков

Большинство примеров в этом разделе используют данные, предоставленные Федеральной резервной системой, к которым вы можете получить доступ с помощью pandas datareader, представленного в [Главе 2, Рыночные и фундаментальные данные](../02_market_and_fundamental_data).

### Как разложить паттерны временных рядов

Данные временных рядов обычно содержат смесь различных паттернов, которые можно разложить на несколько компонентов, каждый из которых представляет категорию базового паттерна. В частности, временные ряды часто состоят из систематических компонентов: тренда, сезонности и циклов, а также несистематического шума. Эти компоненты могут быть объединены в аддитивной линейной модели, особенно когда колебания не зависят от уровня ряда, или в нелинейной мультипликативной модели.

- Функциональность `pandas` для временных рядов и дат [документация](https://pandas.pydata.org/pandas-docs/stable/timeseries.html)
- [Прогнозирование — принципы и практика, Hyndman, R. и Athanasopoulos, G., гл.6 «Декомпозиция временных рядов»](https://otexts.org/fpp2/decomposition.html)

### Статистики скользящего окна и скользящие средние

Библиотека pandas включает очень гибкую функциональность для определения различных типов окон, включая скользящие, экспоненциально взвешенные и расширяющиеся окна.

- Оконные функции `pandas` [документация](https://pandas.pydata.org/pandas-docs/stable/computation.html#window-functions)

### Как измерить автокорреляцию

Автокорреляция (также называемая серийной корреляцией) адаптирует концепцию корреляции к контексту временных рядов: так же как коэффициент корреляции измеряет силу линейной связи между двумя переменными, коэффициент автокорреляции измеряет степень линейной связи между значениями временного ряда, разделёнными заданным лагом.

Мы представляем следующие инструменты для измерения автокорреляции:
- Автокорреляционная функция (ACF)
- Частная автокорреляционная функция (PACF)
- Коррелограмма как график ACF или PACF в зависимости от количества лагов

### Как диагностировать и достичь стационарности

Статистические свойства, такие как среднее, дисперсия или автокорреляция стационарного временного ряда, не зависят от периода, то есть не изменяются со временем. Следовательно, стационарность подразумевает, что временной ряд не имеет тренда или сезонных эффектов и что описательные статистики, такие как среднее или стандартное отклонение, при вычислении для различных скользящих окон являются постоянными или не изменяются значительно со временем.

### Как применять преобразования временных рядов

Чтобы удовлетворить предположение о стационарности линейных моделей временных рядов, нам необходимо преобразовать исходный временной ряд, часто в несколько этапов. Общие преобразования включают применение (натурального) логарифма для преобразования паттерна экспоненциального роста в линейный тренд и стабилизации дисперсии, или дифференцирование.

### Как диагностировать и устранять единичные корни

Единичные корни представляют особую проблему при определении преобразования, которое сделает временной ряд стационарным. На практике временные ряды процентных ставок или цен активов часто не являются стационарными, например, потому что не существует ценового уровня, к которому ряд возвращается. Наиболее известный пример нестационарного ряда — случайное блуждание.

Определяющая характеристика нестационарного ряда с единичным корнем — длинная память: поскольку текущие значения являются суммой прошлых возмущений, крупные инновации сохраняются гораздо дольше, чем для стационарного ряда с возвратом к среднему. Определение правильного преобразования и, в частности, соответствующего числа и лагов для дифференцирования не всегда очевидно. Мы представляем несколько эвристик для направления процесса.

Статистические тесты на единичные корни — это распространённый способ объективного определения того, необходимо ли (дополнительное) дифференцирование. Это статистические тесты гипотез о стационарности, предназначенные для определения необходимости дифференцирования.

### Пример кода: работа с данными временных рядов

- Ноутбук [tsa_and_stationarity](01_tsa_and_stationarity.ipynb) иллюстрирует концепции, обсуждаемые в этом разделе.

### Ресурсы

- [Analysis of Financial Time Series, 3rd Edition, Ruey S. Tsay](https://www.wiley.com/en-us/Analysis+of+Financial+Time+Series%2C+3rd+Edition-p-9780470414354)
- [Quantitative Equity Investing: Techniques and Strategies, Frank J. Fabozzi, Sergio M. Focardi, Petter N. Kolm](https://www.wiley.com/en-us/Quantitative+Equity+Investing%3A+Techniques+and+Strategies-p-9780470262474)
- Анализ временных рядов `statsmodels` [документация](https://www.statsmodels.org/dev/tsa.html)

## Одномерные модели временных рядов

Одномерные модели временных рядов связывают значение временного ряда в интересующий момент времени с линейной комбинацией запаздывающих значений ряда и, возможно, прошлых членов возмущений.

В то время как модели экспоненциального сглаживания основаны на описании тренда и сезонности в данных, модели ARIMA направлены на описание автокорреляций в данных. Модели ARIMA(p, d, q) требуют стационарности и используют два строительных блока:
- Авторегрессионные (AR) члены, состоящие из p запаздывающих значений временного ряда
- Члены скользящего среднего (MA), содержащие q запаздывающих возмущений

### Как строить авторегрессионные модели

AR-модель порядка p направлена на захват линейной зависимости между значениями временного ряда на разных лагах. Она очень похожа на множественную линейную регрессию по запаздывающим значениям результата.

### Как строить модели скользящего среднего

MA-модель порядка q использует q прошлых возмущений вместо запаздывающих значений временного ряда в регрессионноподобной модели. Поскольку мы не наблюдаем значения возмущений белого шума, MA(q) не является регрессионной моделью, как те, которые мы видели ранее. Вместо использования метода наименьших квадратов, модели MA(q) оцениваются с помощью метода максимального правдоподобия (MLE).

### Как строить модели ARIMA и расширения

Авторегрессионная интегрированная модель скользящего среднего ARIMA(p, d, q) объединяет процессы AR(p) и MA(q), чтобы использовать взаимодополняемость этих строительных блоков и упростить разработку модели за счёт использования более компактной формы и уменьшения количества параметров, что в свою очередь снижает риск переобучения.

- Модели пространства состояний statsmodels [документация](https://www.statsmodels.org/dev/statespace.html)

### Пример кода: прогнозирование макроэкономических показателей с помощью моделей ARIMA и SARIMAX

Мы построим модель SARIMAX для месячных данных временного ряда промышленного производства за период 1988-2017 гг. См. ноутбук [arima_models](02_arima_models.ipynb) для деталей реализации.

### Как использовать модели временных рядов для прогнозирования волатильности

Особенно важная область применения одномерных моделей временных рядов — прогнозирование волатильности. Волатильность финансовых временных рядов обычно не постоянна во времени, а изменяется, при этом периоды волатильности группируются вместе. Изменения дисперсии создают проблемы для прогнозирования временных рядов с использованием классических моделей ARIMA.

### Как построить модель прогнозирования волатильности

Разработка модели волатильности для ряда доходностей активов состоит из четырёх шагов:
1. Построение модели временного ряда ARMA для финансового временного ряда на основе серийной зависимости, выявленной ACF и PACF.
2. Тестирование остатков модели на наличие эффектов ARCH/GARCH, снова опираясь на ACF и PACF для ряда квадратов остатков.
3. Спецификация модели волатильности, если эффекты серийной корреляции значимы, и совместная оценка уравнений среднего и волатильности.
4. Тщательная проверка подогнанной модели и её уточнение при необходимости.

### Примеры кода: прогнозы волатильности

Ноутбук [arch_garch_models](03_arch_garch_models.ipynb) демонстрирует использование библиотеки ARCH для оценки моделей временных рядов для прогнозирования волатильности с данными NASDAQ.

### Ресурсы

- NYU Stern [VLAB](https://vlab.stern.nyu.edu/)
- Библиотека ARCH
    - [документация](https://arch.readthedocs.io/en/latest/index.html)
    - [примеры](http://nbviewer.jupyter.org/github/bashtage/arch/blob/master/examples/univariate_volatility_modeling.ipynb)

## Многомерные модели временных рядов

Многомерные модели временных рядов предназначены для одновременного захвата динамики нескольких временных рядов и использования зависимостей между этими рядами для более надёжных прогнозов.

Одномерные модели временных рядов, такие как подход ARMA, ограничены статистическими связями между целевой переменной и её запаздывающими значениями или запаздывающими возмущениями и экзогенными рядами в случае ARMAX. В отличие от этого, многомерные модели временных рядов также позволяют запаздывающим значениям других временных рядов влиять на цель. Этот эффект применяется ко всем рядам, что приводит к сложным взаимодействиям.

Помимо потенциально лучшего прогнозирования, многомерные временные ряды также используются для получения понимания межрядовых зависимостей. Например, в экономике многомерные временные ряды используются для понимания того, как изменения политики одной переменной, такой как процентная ставка, могут повлиять на другие переменные на различных горизонтах.

- [New Introduction to Multiple Time Series Analysis, Lütkepohl, Helmut, Springer, 2005](https://www.springer.com/us/book/9783540401728)

### Векторная авторегрессионная модель (VAR)

Векторная авторегрессионная модель VAR(p) расширяет модель AR(p) на k рядов, создавая систему из k уравнений, где каждое содержит p запаздывающих значений всех k рядов.

Модели VAR(p) также требуют стационарности, поэтому начальные шаги из одномерного моделирования временных рядов переносятся. Сначала исследуйте ряды и определите необходимые преобразования, затем примените расширенный тест Дики-Фуллера, чтобы убедиться, что критерий стационарности выполняется для каждого ряда, и при необходимости примените дополнительные преобразования. Модель может быть оценена с помощью OLS при условии начальной информации или с помощью MLE, что эквивалентно для нормально распределённых ошибок, но не в других случаях.

Если некоторые или все k рядов являются нестационарными с единичным корнем, они могут быть коинтегрированы (см. следующий раздел). Это расширение концепции единичного корня на несколько временных рядов означает, что линейная комбинация двух или более рядов является стационарной и, следовательно, возвращающейся к среднему.

### Пример кода: как использовать модель VAR для прогнозирования макроэкономических показателей

Ноутбук [vector_autoregressive_model](04_vector_autoregressive_model.ipynb) демонстрирует, как использовать `statsmodels` для оценки модели VAR для временных рядов макроэкономических показателей.

### Ресурсы

- Векторная авторегрессия `statsmodels` [документация](https://www.statsmodels.org/dev/vector_ar.html)
- [Time Series Analysis in Python with statsmodels](https://conference.scipy.org/proceedings/scipy2011/pdfs/statsmodels.pdf), Wes McKinney, Josef Perktold, Skipper Seabold, SciPY Conference 2011

## Коинтеграция — временные ряды с общим трендом

Концепция интегрированного многомерного ряда усложняется тем фактом, что все компонентные ряды процесса могут быть индивидуально интегрированными, но процесс не является совместно интегрированным в том смысле, что существует одна или более линейных комбинаций рядов, которые производят новый стационарный ряд.

Другими словами, комбинация двух коинтегрированных рядов имеет стабильное среднее, к которому эта линейная комбинация возвращается. Многомерный ряд с такой характеристикой называется коинтегрированным. Это также применяется, когда отдельные ряды интегрированы более высокого порядка и линейная комбинация уменьшает общий порядок интеграции.

Мы демонстрируем два основных подхода к тестированию на коинтеграцию:
- Двухшаговый метод Энгла-Грейнджера
- Процедура Йохансена

### Парная торговля: статистический арбитраж с коинтеграцией

Статистический арбитраж относится к стратегиям, которые используют некоторую статистическую модель или метод для извлечения выгоды из того, что кажется относительной недооценкой активов, при сохранении определённого уровня рыночной нейтральности.

Парная торговля — это концептуально простая стратегия, которая используется алгоритмическими трейдерами как минимум с середины восьмидесятых (Gatev, Goetzmann, and Rouwenhorst 2006). Цель — найти два актива, цены которых исторически двигались вместе, отслеживать спред (разницу между их ценами) и, когда спред расширяется, покупать отстающего, который упал ниже общего тренда, и продавать в короткую лидера. Если связь сохраняется, длинная и/или короткая ноги принесут прибыль по мере схождения цен и закрытия позиций.

Этот подход распространяется на многомерный контекст путём формирования корзин из нескольких ценных бумаг и торговли одним активом против корзины или двух корзин друг против друга.

На практике стратегия требует двух шагов:
1. Фаза формирования: идентификация ценных бумаг, которые имеют долгосрочную связь с возвратом к среднему. В идеале спред должен иметь высокую дисперсию, чтобы обеспечить частые прибыльные сделки, при этом надёжно возвращаясь к общему тренду.
2. Фаза торговли: запуск правил входа и выхода при движениях цен, вызывающих расхождение и схождение спреда.

За последние несколько лет в результате всё более активных исследований в этой области по нескольким классам активов возникло несколько подходов к фазам формирования и торговли. В следующем подразделе описаны ключевые различия, прежде чем мы перейдём к примеру применения.

### Альтернативные подходы к выбору и торговле совместно движущимися активами

Недавний всесторонний обзор стратегий парной торговли [Statistical Arbitrage Pairs Trading Strategies: Review and Outlook](https://www.iwf.rw.fau.de/files/2016/03/09-2015.pdf), Krauss (2017) выделяет четыре различные методологии плюс ряд других более современных подходов, включая прогнозы на основе ML:

- **Дистанционный** подход: самый старый и наиболее изученный метод идентифицирует пары-кандидаты с помощью метрик расстояния, таких как корреляция, и использует непараметрические пороги, такие как полосы Боллинджера, для запуска сделок входа и выхода. Вычислительная простота позволяет применять его в больших масштабах с продемонстрированной прибыльностью на различных рынках и классах активов в течение длительных периодов времени начиная с Gatev, et al. (2006). Однако производительность снизилась в последнее время.
- **Коинтеграционный** подход: как описано ранее, этот подход опирается на эконометрическую модель долгосрочной связи между двумя или более переменными и позволяет проводить статистические тесты, которые обещают большую надёжность, чем простые метрики расстояния. Примеры в этой категории используют процедуры Энгла-Грейнджера и Йохансена для идентификации пар и корзин ценных бумаг, а также более простые эвристики, которые стремятся захватить концепцию (Vidyamurthy 2004). Торговые правила часто напоминают простые пороги, используемые с метриками расстояния.
- **Временнорядный** подход: с фокусом на фазе торговли стратегии в этой категории стремятся моделировать спред как стохастический процесс с возвратом к среднему и соответственно оптимизировать правила входа и выхода (Elliott, Hoek, and Malcolm 2005). Предполагается, что перспективные пары уже идентифицированы.
- Подход **стохастического управления**: аналогично временнорядному подходу, цель — оптимизировать торговые правила с использованием теории стохастического управления для нахождения функций ценности и политики для достижения оптимального портфеля (Liu and Timmermann 2013). Мы рассмотрим этот тип подхода в Главе 21, Обучение с подкреплением.
- **Другие подходы**: помимо идентификации пар на основе обучения без учителя, такого как анализ главных компонент (см. Главу 13, Обучение без учителя), и статистических моделей, таких как копулы (Patton 2012), машинное обучение стало популярным в последнее время для идентификации пар на основе их относительных прогнозов цены или доходности (Huck 2019). Мы рассмотрим несколько алгоритмов ML, которые могут быть использованы для этой цели, и проиллюстрируем соответствующие многомерные стратегии парной торговли в следующих главах.

### Пример кода: парная торговля на практике

**Дистанционный подход** идентифицирует пары, используя корреляцию (нормализованных) цен активов или их доходностей, и является простым и на порядки менее вычислительно интенсивным, чем тесты на коинтеграцию.
- Ноутбук [cointegration_tests](05_cointegration_tests.ipynb) иллюстрирует это для выборки из ~150 акций с четырьмя годами дневных данных: вычисление корреляции с доходностями ETF занимает ~30мс, по сравнению с 18 секундами для набора тестов на коинтеграцию (с использованием statsmodels) — в 600 раз медленнее.

Преимущество в скорости особенно ценно, потому что количество потенциальных пар является произведением количества кандидатов, рассматриваемых с каждой стороны, так что оценка комбинаций из 100 акций и 100 ETF требует сравнения 10 000 тестов (мы обсудим проблему смещения множественного тестирования ниже).

С другой стороны, метрики расстояния не обязательно выбирают наиболее прибыльные пары: корреляция максимизируется при идеальном совместном движении, которое в свою очередь исключает реальные торговые возможности. Эмпирические исследования подтверждают, что волатильность ценового спреда коинтегрированных пар почти в два раза выше, чем волатильность ценового спреда дистанционных пар (Huck and Afawubo 2015).

Чтобы сбалансировать компромисс между вычислительными затратами и качеством результирующих пар, Krauss (2017) рекомендует процедуру, объединяющую оба подхода на основе его обзора литературы:
1. Выбрать пары со стабильным спредом, который показывает небольшой дрейф, чтобы уменьшить количество кандидатов
2. Протестировать оставшиеся пары с наивысшей дисперсией спреда на коинтеграцию

Этот процесс направлен на выбор коинтегрированных пар с меньшим риском расхождения при обеспечении более волатильных спредов, которые в свою очередь генерируют более высокие возможности для прибыли.

Большое количество тестов вводит смещение подглядывания в данные, как обсуждалось в Главе 6, Рабочий процесс машинного обучения: множественное тестирование, вероятно, увеличит количество ложноположительных результатов, которые ошибочно отвергают нулевую гипотезу об отсутствии коинтеграции. Хотя статистическая значимость может не быть необходимой для прибыльной торговли (Chan 2008), исследование товарных пар (Cummins and Bucca 2012) показывает, что контроль частоты семейных ошибок для улучшения мощности тестов согласно Romano and Wolf (2010) может привести к лучшей производительности.

#### Вычисление эвристик на основе расстояний для идентификации коинтегрированных пар

- Ноутбук [cointegration_tests](05_cointegration_tests.ipynb) подробнее рассматривает, насколько предсказательными являются различные эвристики для степени совместного движения цен активов для результата тестов на коинтеграцию. Пример кода использует выборку из 172 акций и 138 ETF, торгуемых на NYSE и NASDAQ, с дневными данными с 2010 по 2019 год, предоставленными Stooq.

Ценные бумаги представляют наибольший средний долларовый объём за период выборки в своём соответствующем классе; высококоррелированные и стационарные активы были удалены. См. ноутбук [create_datasets](../data/create_datasets.ipynb) в папке data репозитория GitHub для инструкций по загрузке данных и ноутбук cointegration_tests для соответствующего кода и дополнительных деталей предобработки и разведочного анализа.

#### Предварительное вычисление тестов на коинтеграцию

Ноутбук [statistical_arbitrage_with_cointegrated_pairs](06_statistical_arbitrage_with_cointegrated_pairs.ipynb) реализует стратегию статистического арбитража на основе коинтеграции для выборки акций и ETF за период 2017-2019.

Сначала он генерирует и сохраняет тесты на коинтеграцию для всех пар-кандидатов и результирующие торговые сигналы, прежде чем мы проведём бэктест стратегии на основе этих сигналов, учитывая вычислительную интенсивность процесса.

### Ресурсы

- Quantopian предлагает различные ресурсы по парной торговле:
    - [Введение в парную торговлю](https://www.quantopian.com/lectures/introduction-to-pairs-trading)
    - [Quantopian Johansen](https://www.quantopian.com/posts/trading-baskets-co-integrated-with-spy)
    - [Quantopian PT](https://www.quantopian.com/posts/how-to-build-a-pairs-trading-strategy-on-quantopian)
    - [Основы парной торговли: корреляция, коинтеграция и стратегия](https://blog.quantinsti.com/pairs-trading-basics/)
- Дополнительные публикации в блогах:
    - [Парная торговля с использованием методов Data Science: простые торговые стратегии, часть 3](https://medium.com/auquan/pairs-trading-data-science-7dbedafcfe5a)
    - [Парная торговля Йохансен и Калман](https://letianzj.github.io/kalman-filter-pairs-trading.html)
    - [Копулы](https://twiecki.io/blog/2018/05/03/copulas/) от Thomas Wiecki

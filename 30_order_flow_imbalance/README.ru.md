# Глава 30: Order Flow Imbalance — Стратегия микроструктуры для внутридневной торговли

## Обзор

**Order Flow Imbalance (OFI)** — это мера дисбаланса между давлением покупателей и продавцов на уровне книги ордеров (order book). Экстремальный дисбаланс часто предшествует краткосрочному движению цены. В этой главе мы используем машинное обучение для прогнозирования краткосрочных ценовых движений на основе микроструктуры рынка.

### Что такое микроструктура рынка?

Микроструктура рынка — это область финансов, изучающая процессы и механизмы, с помощью которых происходит обмен активами. В отличие от традиционного анализа, который фокусируется на фундаментальных показателях или технических индикаторах, микроструктура рассматривает:

- **Книгу ордеров (Order Book)** — очередь заявок на покупку и продажу
- **Поток ордеров (Order Flow)** — последовательность рыночных и лимитных ордеров
- **Механизм формирования цены** — как цена реагирует на ордера
- **Ликвидность** — способность рынка исполнять сделки без существенного влияния на цену

## Торговая стратегия

### Суть стратегии

Анализ дисбаланса потока ордеров из данных L2 книги ордеров. Модель машинного обучения предсказывает вероятность разворота или продолжения движения на горизонте 1-5 минут.

### Сигналы на вход

| Тип сигнала | Условие | Действие |
|-------------|---------|----------|
| **Long (покупка)** | Сильный buy imbalance + ML предсказывает продолжение | Открыть длинную позицию |
| **Short (продажа)** | Сильный sell imbalance + ML предсказывает продолжение | Открыть короткую позицию |
| **Mean-reversion** | Экстремальный дисбаланс + ML предсказывает разворот | Торговать против дисбаланса |

### Преимущество (Edge)

Информация из книги ордеров опережает ценовые движения — мы видим намерения участников рынка до того, как они повлияют на цену.

---

## Теоретические основы

### Книга ордеров (Order Book)

Книга ордеров — это электронный список всех активных заявок на покупку (bid) и продажу (ask) актива:

```
Пример книги ордеров BTC/USDT:

         ASKS (продавцы)
   ┌────────────────────────┐
   │ Цена      │ Размер     │
   ├───────────┼────────────┤
   │ 45,120.50 │ 2.5 BTC    │  <- Best Ask (лучшее предложение)
   │ 45,121.00 │ 5.2 BTC    │
   │ 45,122.00 │ 10.0 BTC   │
   │ 45,125.00 │ 15.3 BTC   │
   │ 45,130.00 │ 8.7 BTC    │
   └───────────┴────────────┘

   ┌────────────────────────┐
   │ Цена      │ Размер     │
   ├───────────┼────────────┤
   │ 45,120.00 │ 3.1 BTC    │  <- Best Bid (лучший спрос)
   │ 45,119.50 │ 7.8 BTC    │
   │ 45,118.00 │ 4.2 BTC    │
   │ 45,115.00 │ 12.0 BTC   │
   │ 45,110.00 │ 6.5 BTC    │
   └───────────┴────────────┘
         BIDS (покупатели)

Спред = 45,120.50 - 45,120.00 = $0.50 (1.1 bps)
Mid Price = (45,120.50 + 45,120.00) / 2 = $45,120.25
```

### Order Flow Imbalance (OFI)

OFI измеряет чистое давление покупателей vs продавцов, основываясь на изменениях книги ордеров. Формула основана на работе Cont et al. (2014):

```
OFI = ΔBid + ΔAsk

где:
  ΔBid = изменение на стороне покупателей
  ΔAsk = изменение на стороне продавцов

Если bid_price выросла:
    ΔBid = новый bid_size (агрессивные покупатели)
Если bid_price не изменилась:
    ΔBid = изменение bid_size
Если bid_price упала:
    ΔBid = -старый bid_size (покупатели отступают)

Аналогично для ask стороны (с противоположным знаком)
```

**Интерпретация:**
- **OFI > 0** — давление покупателей преобладает → вероятен рост цены
- **OFI < 0** — давление продавцов преобладает → вероятно падение цены
- **|OFI| большой** — сильный дисбаланс, высокая вероятность движения

### VPIN (Volume-Synchronized Probability of Informed Trading)

VPIN — индикатор "токсичности" потока ордеров, показывающий долю информированных трейдеров:

```
VPIN = |Buy Volume - Sell Volume| / Total Volume

Высокий VPIN (> 0.7):
  - Много информированных трейдеров
  - Повышенный риск для маркет-мейкеров
  - Возможно значительное движение цены

Низкий VPIN (< 0.3):
  - Преобладают шумовые трейдеры
  - Рынок в равновесии
  - Цена близка к справедливой
```

### Kyle's Lambda (λ)

Показатель влияния ордеров на цену:

```
ΔPrice = λ × Order Flow

λ высокий → рынок неликвидный, ордера сильно двигают цену
λ низкий → рынок ликвидный, ордера слабо влияют на цену
```

---

## Техническая спецификация

### Notebooks для создания

| # | Notebook | Описание |
|---|----------|----------|
| 1 | `01_order_book_data.ipynb` | Загрузка и парсинг L2 данных книги ордеров |
| 2 | `02_order_flow_basics.ipynb` | Теория: OFI, VPIN, Kyle's Lambda |
| 3 | `03_ofi_calculation.ipynb` | Расчет метрик Order Flow Imbalance |
| 4 | `04_feature_engineering.ipynb` | Создание признаков из снимков книги ордеров |
| 5 | `05_labeling.ipynb` | Создание меток (будущее движение цены) |
| 6 | `06_model_training.ipynb` | Обучение LightGBM для предсказания направления |
| 7 | `07_signal_generation.ipynb` | Генерация торговых сигналов |
| 8 | `08_execution_simulation.ipynb` | Симуляция исполнения с учетом проскальзывания |
| 9 | `09_backtesting.ipynb` | Фреймворк внутридневного бэктестинга |
| 10 | `10_latency_analysis.ipynb` | Анализ влияния задержки на P&L |
| 11 | `11_production_considerations.ipynb` | Заметки по real-time реализации |

### Требования к данным

```
Данные книги ордеров (L2):
├── Bid/Ask цены (10+ уровней)
├── Bid/Ask размеры на каждом уровне
├── Временные метки (миллисекунды или лучше)
├── Сделки (time & sales)
└── Минимум 1 год исторических данных

Рекомендуемые источники:
├── Crypto: Bybit API (бесплатно)
├── Crypto: Binance/Coinbase API
├── Lobster Data (академический, NASDAQ)
├── Algoseek (коммерческий)
├── Futures: CME DataMine
└── Симуляция: синтетические данные

Инструменты:
├── BTC/USDT (Биткоин)
├── ETH/USDT (Эфириум)
├── SOL/USDT (Солана)
└── Высокий объем = лучший сигнал
```

---

## Расчет Order Flow Imbalance

### Алгоритм расчета OFI

```python
def calculate_ofi(book_t, book_t1):
    """
    Order Flow Imbalance по методологии Cont et al. (2014)

    Параметры:
        book_t: снимок книги ордеров в момент t
        book_t1: снимок книги ордеров в момент t+1

    Возвращает:
        ofi: значение дисбаланса (-∞ до +∞)
    """
    # Изменения на стороне bid (покупатели)
    if book_t1['bid_price'] > book_t['bid_price']:
        # Цена bid выросла - агрессивные покупатели
        delta_bid = book_t1['bid_size']
    elif book_t1['bid_price'] == book_t['bid_price']:
        # Цена не изменилась - смотрим на изменение размера
        delta_bid = book_t1['bid_size'] - book_t['bid_size']
    else:
        # Цена bid упала - покупатели отступают
        delta_bid = -book_t['bid_size']

    # Изменения на стороне ask (продавцы)
    if book_t1['ask_price'] < book_t['ask_price']:
        # Цена ask упала - агрессивные продавцы
        delta_ask = -book_t1['ask_size']
    elif book_t1['ask_price'] == book_t['ask_price']:
        # Цена не изменилась - смотрим на изменение размера
        delta_ask = -(book_t1['ask_size'] - book_t['ask_size'])
    else:
        # Цена ask выросла - продавцы отступают
        delta_ask = book_t['ask_size']

    ofi = delta_bid + delta_ask
    return ofi

# Агрегация OFI по временным окнам
ofi_1min = ofi_series.rolling('1min').sum()
ofi_5min = ofi_series.rolling('5min').sum()
ofi_15min = ofi_series.rolling('15min').sum()
```

### Нормализация OFI

```python
def normalize_ofi(ofi, window=100):
    """
    Z-score нормализация OFI для сравнения между инструментами
    """
    mean = ofi.rolling(window).mean()
    std = ofi.rolling(window).std()
    return (ofi - mean) / std
```

---

## Инженерия признаков (Feature Engineering)

### Полный набор признаков из книги ордеров

```python
features = {
    # ═══════════════════════════════════════════════════════
    # МЕТРИКИ ДИСБАЛАНСА (10 признаков)
    # ═══════════════════════════════════════════════════════
    'ofi_1min': 'сумма OFI за 1 минуту',
    'ofi_5min': 'сумма OFI за 5 минут',
    'ofi_15min': 'сумма OFI за 15 минут',
    'ofi_zscore': 'Z-score OFI (нормализованный)',
    'volume_imbalance': '(bid_vol - ask_vol) / (bid_vol + ask_vol)',
    'depth_imbalance_l1': 'дисбаланс глубины на 1 уровне',
    'depth_imbalance_l5': 'дисбаланс глубины на 5 уровнях',
    'depth_imbalance_l10': 'дисбаланс глубины на 10 уровнях',
    'weighted_imbalance': 'взвешенный по цене дисбаланс',
    'cumulative_ofi': 'накопленный OFI за сессию',

    # ═══════════════════════════════════════════════════════
    # СПРЕД И ЛИКВИДНОСТЬ (10 признаков)
    # ═══════════════════════════════════════════════════════
    'spread_bps': 'спред в базисных пунктах',
    'spread_zscore': 'Z-score спреда',
    'spread_pct_change': 'изменение спреда',
    'total_depth_l5': 'суммарная глубина (bid + ask) на 5 уровнях',
    'total_depth_l10': 'суммарная глубина на 10 уровнях',
    'depth_ratio': 'bid_depth / ask_depth',
    'liquidity_score': 'композитный показатель ликвидности',
    'bid_depth_change': 'изменение глубины bid',
    'ask_depth_change': 'изменение глубины ask',
    'depth_asymmetry': 'асимметрия глубины по уровням',

    # ═══════════════════════════════════════════════════════
    # ТОРГОВЫЙ ПОТОК (10 признаков)
    # ═══════════════════════════════════════════════════════
    'buy_volume_1min': 'объем покупок за 1 мин',
    'sell_volume_1min': 'объем продаж за 1 мин',
    'trade_imbalance': '(buys - sells) / (buys + sells)',
    'trade_count_ratio': 'количество покупок / продаж',
    'avg_trade_size': 'средний размер сделки',
    'large_trade_indicator': 'сделка > 2σ от среднего',
    'vwap_distance': '(цена - VWAP) / цена',
    'trade_intensity': 'количество сделок в секунду',
    'buy_aggression': '% покупок по ask',
    'sell_aggression': '% продаж по bid',

    # ═══════════════════════════════════════════════════════
    # ФОРМА КНИГИ ОРДЕРОВ (8 признаков)
    # ═══════════════════════════════════════════════════════
    'bid_slope': 'наклон bid стороны (глубина vs цена)',
    'ask_slope': 'наклон ask стороны',
    'slope_asymmetry': 'асимметрия наклонов',
    'resilience': 'скорость восстановления после крупной сделки',
    'price_impact_bid': 'влияние на цену при покупке 1 BTC',
    'price_impact_ask': 'влияние на цену при продаже 1 BTC',
    'book_concentration': 'концентрация ликвидности на топ уровнях',
    'gap_detection': 'наличие больших разрывов в книге',

    # ═══════════════════════════════════════════════════════
    # VPIN И ТОКСИЧНОСТЬ (7 признаков)
    # ═══════════════════════════════════════════════════════
    'vpin': 'Volume-Sync Probability of Informed Trading',
    'vpin_rolling': 'скользящий VPIN',
    'vpin_zscore': 'Z-score VPIN',
    'toxicity_indicator': 'композитный индикатор токсичности',
    'informed_ratio': 'доля информированных трейдеров',
    'adverse_selection': 'риск неблагоприятного отбора',
    'kyle_lambda': "Kyle's λ (price impact)",

    # ═══════════════════════════════════════════════════════
    # МОМЕНТУМ И ВОЛАТИЛЬНОСТЬ (7 признаков)
    # ═══════════════════════════════════════════════════════
    'price_momentum_1min': 'доходность за 1 минуту',
    'price_momentum_5min': 'доходность за 5 минут',
    'volatility_1min': 'реализованная волатильность за 1 мин',
    'volatility_5min': 'реализованная волатильность за 5 мин',
    'high_low_range': '(high - low) / mid',
    'return_zscore': 'Z-score доходности',
    'momentum_ofi_corr': 'корреляция моментума и OFI',

    # ═══════════════════════════════════════════════════════
    # ВРЕМЕННЫЕ ПРИЗНАКИ (5 признаков)
    # ═══════════════════════════════════════════════════════
    'hour_of_day': 'час дня (циклический)',
    'minute_of_hour': 'минута часа',
    'day_of_week': 'день недели',
    'session': 'торговая сессия (Asia/Europe/US)',
    'time_to_close': 'время до закрытия сессии',
}

# Итого: 57 признаков
```

---

## Расчет VPIN

```python
def calculate_vpin(trades, bucket_size=50):
    """
    VPIN индикатор для определения токсичности

    Параметры:
        trades: DataFrame со сделками (time, price, volume, side)
        bucket_size: размер объемного бакета

    Возвращает:
        vpin: Series с значениями VPIN
    """
    # Классификация сделок как buy/sell (Lee-Ready алгоритм)
    trades['side'] = classify_trades_lee_ready(trades)

    # Создание объемных бакетов
    buckets = create_volume_buckets(trades, bucket_size)

    # Расчет дисбаланса для каждого бакета
    vpin = []
    for bucket in buckets:
        buy_vol = bucket[bucket['side'] == 'buy']['volume'].sum()
        sell_vol = bucket[bucket['side'] == 'sell']['volume'].sum()
        total_vol = buy_vol + sell_vol

        if total_vol > 0:
            vpin.append(abs(buy_vol - sell_vol) / total_vol)
        else:
            vpin.append(0)

    # Скользящий VPIN (среднее по N бакетам)
    return pd.Series(vpin).rolling(50).mean()


def classify_trades_lee_ready(trades):
    """
    Lee-Ready алгоритм классификации сделок

    Правила:
    1. Если цена > mid → buy
    2. Если цена < mid → sell
    3. Если цена = mid → tick test (сравнение с предыдущей сделкой)
    """
    mid = (trades['bid'] + trades['ask']) / 2

    # Tick test
    tick = np.sign(trades['price'].diff())
    tick = tick.replace(0, np.nan).ffill()

    # Классификация
    side = np.where(
        trades['price'] > mid, 'buy',
        np.where(trades['price'] < mid, 'sell',
            np.where(tick > 0, 'buy', 'sell'))
    )

    return side
```

---

## Архитектура модели

### Структура входных данных

```
Вход: 50+ микроструктурных признаков
├── OFI признаки (10)
├── Признаки глубины (10)
├── Торговый поток (10)
├── Форма книги ордеров (8)
├── VPIN и токсичность (7)
├── Технические (7)
└── Временные (5)
```

### Конфигурация LightGBM

```python
params = {
    'objective': 'binary',      # или 'multiclass' для 3 класса
    'metric': 'auc',
    'boosting_type': 'gbdt',
    'max_depth': 6,             # Неглубокие деревья для скорости
    'num_leaves': 31,
    'learning_rate': 0.05,
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
    'bagging_freq': 5,
    'min_child_samples': 100,   # Больше для устойчивости
    'verbose': -1,
    'n_jobs': -1,
    'seed': 42
}

# Почему LightGBM?
# ✓ Очень быстрое обучение и инференс (< 1мс)
# ✓ Встроенная обработка категориальных признаков
# ✓ Feature importance для интерпретируемости
# ✓ Хорошо работает с табличными данными
```

### Выходы модели

```
Выход:
├── P(price_up_1min)    — вероятность роста за 1 мин
├── P(price_up_5min)    — вероятность роста за 5 мин
├── Expected magnitude  — ожидаемая величина движения (регрессия)
└── Confidence score    — уверенность предсказания
```

### Торговые правила

```python
def generate_signal(prediction, ofi, spread):
    """
    Генерация торгового сигнала
    """
    # Пороги
    prob_threshold_long = 0.55
    prob_threshold_short = 0.45
    ofi_threshold = 2.0  # Z-score
    max_spread = 5.0     # bps

    # Проверка ликвидности
    if spread > max_spread:
        return 'HOLD', 0

    # Long сигнал
    if prediction > prob_threshold_long and ofi > ofi_threshold:
        confidence = (prediction - 0.5) * 2  # 0 to 1
        return 'LONG', confidence

    # Short сигнал
    if prediction < prob_threshold_short and ofi < -ofi_threshold:
        confidence = (0.5 - prediction) * 2
        return 'SHORT', confidence

    return 'HOLD', 0
```

---

## Исполнение и риск-менеджмент

### Требования к задержке (Latency)

```
Компонент                    Целевое время
──────────────────────────────────────────
Получение данных:            < 1мс
Расчет признаков:            < 1мс
Предсказание модели:         < 1мс
Генерация ордера:            < 1мс
Отправка ордера:             < 10мс
──────────────────────────────────────────
ИТОГО:                       < 50мс

Примечание: Для HFT требуется колокация (< 1мс)
```

### Издержки исполнения

```
Тип издержки                 Оценка
──────────────────────────────────────────
Комиссия (maker):            0.01% (1 bps)
Комиссия (taker):            0.05% (5 bps)
Спред:                       1-5 bps
Market impact:               зависит от размера
Проскальзывание:             0-10 bps
──────────────────────────────────────────

Модель проскальзывания:
slippage = base_slippage + (order_size / avg_depth) * impact_coef
```

### Управление позицией

```
Параметр                     Значение
──────────────────────────────────────────
Максимальная позиция:        0.1-1.0 BTC
Максимальное время удержания: 5 минут
Stop-loss:                   2-3 тика (0.1-0.15%)
Take-profit:                 3-5 тиков (0.15-0.25%)
Плоская позиция EOD:         Да
Максимальный дневной убыток: 2% от капитала
──────────────────────────────────────────
```

---

## Ключевые метрики

### Качество сигнала

| Метрика | Описание | Целевое значение |
|---------|----------|------------------|
| IC (Information Coefficient) | Корреляция предсказания и результата | > 0.05 |
| Hit Rate | Доля правильных предсказаний | > 52% |
| AUC-ROC | Площадь под ROC-кривой | > 0.55 |
| Precision@10% | Точность на топ-10% сигналов | > 60% |

### Качество исполнения

| Метрика | Описание | Целевое значение |
|---------|----------|------------------|
| Fill Rate | % исполненных ордеров | > 95% |
| Slippage vs Expected | Отклонение от ожидаемой цены | < 2 bps |
| Latency | Время от сигнала до исполнения | < 50мс |

### P&L метрики

| Метрика | Описание | Целевое значение |
|---------|----------|------------------|
| Gross P&L | P&L до издержек | Положительный |
| Net P&L | P&L после издержек | Положительный |
| Sharpe (intraday) | Sharpe ratio внутри дня | > 2.0 |
| Win Rate | % прибыльных сделок | > 50% |
| Profit Factor | Gross Profit / Gross Loss | > 1.5 |

### Риск-метрики

| Метрика | Описание | Целевое значение |
|---------|----------|------------------|
| Max Drawdown (intraday) | Максимальная просадка | < 1% |
| # убыточных дней | Количество убыточных дней | < 40% |
| VaR (1 день, 95%) | Value at Risk | < 1% капитала |

---

## Зависимости

### Python

```python
# Обработка данных
pandas>=1.5.0
numpy>=1.23.0
polars>=0.18.0       # Для больших данных

# Машинное обучение
lightgbm>=4.0.0
scikit-learn>=1.2.0

# Производительность
numba>=0.57.0        # JIT компиляция
cython>=0.29.0       # C-расширения

# Визуализация
matplotlib>=3.6.0
plotly>=5.10.0

# Работа с данными
lobsterdata>=0.1.0   # Формат LOBSTER
ccxt>=4.0.0          # Криптобиржи
```

### Rust (рекомендуется для production)

```toml
[dependencies]
tokio = { version = "1", features = ["full"] }
reqwest = { version = "0.11", features = ["json"] }
serde = { version = "1.0", features = ["derive"] }
ndarray = "0.15"
chrono = "0.4"
```

---

## Ожидаемые результаты

1. **Парсер книги ордеров** для L2 данных (Bybit, Binance формат)
2. **Pipeline расчета OFI** с несколькими временными окнами
3. **Библиотека признаков (50+ features)** из книги ордеров
4. **LightGBM модель** с точностью > 52% на 1-минутном горизонте
5. **Симулятор исполнения** с реалистичным проскальзыванием
6. **Внутридневной бэктест** с gross Sharpe > 2.0 (до издержек)
7. **Анализ влияния latency** на прибыльность

---

## Литература

### Основные статьи

1. **Cont, R., Kukanov, A., & Stoikov, S. (2014)**
   [The Price Impact of Order Book Events](https://arxiv.org/abs/1011.6402)
   *Оригинальная статья по OFI*

2. **Easley, D., López de Prado, M., & O'Hara, M. (2012)**
   [Flow Toxicity and Liquidity in a High-frequency World](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1695596)
   *VPIN и Flash Crash*

3. **Kyle, A. S. (1985)**
   [Continuous Auctions and Insider Trading](https://www.jstor.org/stable/1913210)
   *Классическая модель микроструктуры*

### Книги

4. **López de Prado, M. (2020)**
   *Machine Learning for Asset Managers*
   Cambridge University Press

5. **Cartea, Á., Jaimungal, S., & Penalva, J. (2015)**
   *Algorithmic and High-Frequency Trading*
   Cambridge University Press

6. **Harris, L. (2003)**
   *Trading and Exchanges: Market Microstructure for Practitioners*
   Oxford University Press

### Ресурсы

- [LOBSTER: Limit Order Book System](https://lobsterdata.com/) — Академические данные
- [Bybit API Documentation](https://bybit-exchange.github.io/docs/) — Криптоданные
- [High-Frequency Trading Review](https://www.newyorkfed.org/research/staff_reports/sr795) — Fed NY

---

## Уровень сложности

⭐⭐⭐⭐⭐ (Эксперт)

### Необходимые знания

- Микроструктура рынка и механика книги ордеров
- Высокочастотная торговля (HFT)
- Машинное обучение (gradient boosting)
- Программирование (Python/Rust)
- Низколатентные системы

---

## Важные предупреждения

> ⚠️ **Инфраструктура**: HFT стратегии требуют значительных инвестиций в инфраструктуру

> ⚠️ **Задержка критична**: Колокация может быть необходима для конкурентоспособности

> ⚠️ **Регуляторные требования**: SEC, CFTC, MiFID II имеют специфические правила для алгоритмической торговли

> ⚠️ **Paper trading обязателен**: Тестирование на реальных рыночных данных без реального капитала

> ⚠️ **Образовательные цели**: Эта глава — учебный материал, не production-ready торговая система

---

## Реализация на Rust

См. директорию `rust_examples/` для полной реализации на Rust с использованием Bybit API для криптовалютных данных. Rust рекомендуется для production-систем благодаря:

- Гарантиям безопасности памяти
- Производительности, сравнимой с C/C++
- Отсутствию garbage collector (предсказуемая latency)
- Отличной поддержке асинхронного программирования

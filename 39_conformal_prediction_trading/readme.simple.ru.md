# Глава 39: Конформное предсказание — Торгуй только когда уверен!

## Что это такое простыми словами?

Представь, что ты играешь в дартс. Иногда ты точно знаешь, что попадёшь в яблочко, а иногда совсем не уверен. **Конформное предсказание** — это способ честно сказать: «Я попаду куда-то в эту область» вместо «Я точно попаду в эту точку».

### Простая аналогия: Прогноз погоды

Когда метеоролог говорит «завтра будет 20 градусов», он может ошибиться. Но если он скажет «завтра будет от 18 до 22 градусов» — он почти наверняка окажется прав!

**Конформное предсказание** делает то же самое для машинного обучения:
- Вместо: «Цена Bitcoin завтра будет $50,000»
- Говорит: «Цена Bitcoin завтра будет между $48,000 и $52,000»

И самое важное — оно **гарантирует**, что в 90% случаев реальная цена попадёт в этот интервал!

---

## Главная идея для торговли

### Аналогия: Опытный рыбак

Представь опытного рыбака:
- Когда вода мутная и непонятно, где рыба — он **не забрасывает удочку**
- Когда вода чистая и он **точно видит** где рыба — он забрасывает и ловит

Так же работает наша торговая стратегия:
- Широкий интервал (большая неопределённость) → **не торгуем**
- Узкий интервал (высокая уверенность) → **торгуем!**

### Аналогия: Прыжок через лужу

Ты стоишь перед лужей и хочешь перепрыгнуть:
- Если ты уверен, что **точно** перепрыгнешь → прыгаешь!
- Если не уверен → лучше обойти

В трейдинге:
- Модель уверена в росте → покупаем
- Модель уверена в падении → продаём
- Модель не уверена → ждём

---

## Как это работает? Пошагово для школьника

### Шаг 1: Тренируем модель (как учим собаку командам)

Сначала мы показываем модели много примеров:
- «Когда было так — цена выросла»
- «Когда было так — цена упала»

Это как учить собаку: показываешь мячик, собака приносит — даёшь вкусняшку.

### Шаг 2: Проверяем на контрольных примерах

Берём примеры, которые модель НЕ видела, и смотрим как сильно она ошибается:
- Иногда ошиблась на 1%
- Иногда на 2%
- Иногда на 0.5%

Собираем все эти ошибки в список.

### Шаг 3: Выбираем «запас прочности»

Если мы хотим быть правыми в 90% случаев, мы берём такую ошибку, которая покрывает 90% наших прошлых ошибок.

**Пример**: Если в 90% случаев мы ошибались не больше чем на 3%, то наш «запас прочности» = 3%.

### Шаг 4: Делаем предсказание с интервалом

Когда модель говорит «цена будет 100», мы добавляем запас:
- Нижняя граница: 100 - 3 = **97**
- Верхняя граница: 100 + 3 = **103**

Теперь мы говорим: «Цена будет между 97 и 103»

---

## Почему это полезно для трейдера?

### Аналогия: Два стрелка

Представь двух стрелков:

**Стрелок 1 (обычная модель):**
- «Я попаду точно в центр!»
- Но часто промахивается и не признаётся

**Стрелок 2 (конформное предсказание):**
- «Я попаду куда-то в эту область»
- Когда область маленькая — говорит «я уверен»
- Когда область большая — говорит «я не уверен, лучше не стрелять»

Какому стрелку ты бы доверился? Конечно второму!

### Реальный пример с Bitcoin

Представим, модель анализирует Bitcoin:

**Ситуация 1: Спокойный рынок**
```
Предсказание: +2% за день
Интервал: от +1% до +3%
Ширина интервала: 2%
```
Вся область положительная! Модель уверена в росте → **ПОКУПАЕМ!**

**Ситуация 2: Волатильный рынок**
```
Предсказание: +1% за день
Интервал: от -5% до +7%
Ширина интервала: 12%
```
Интервал огромный и включает падение → **НЕ ТОРГУЕМ, ждём**

---

## Размер позиции: чем увереннее — тем больше ставка

### Аналогия: Ставки на футбол

Представь, ты болельщик и делаешь ставки:
- Играет твоя любимая команда против слабого соперника → ставишь много
- Играют две равные команды → ставишь мало или не ставишь

В трейдинге то же самое:
- Узкий интервал (уверенность высокая) → большая позиция
- Широкий интервал (уверенность низкая) → маленькая позиция

### Формула размера позиции

```
Размер = 1 / Ширина_интервала
```

- Ширина 1% → Размер = 1/0.01 = 100 (ограничиваем до 100%)
- Ширина 5% → Размер = 1/0.05 = 20%
- Ширина 10% → Размер = 1/0.10 = 10%

---

## Три типа конформного предсказания

### 1. Раздельное (Split) — самое простое

**Аналогия: Тест в школе**

Учитель хочет понять, как хорошо ученики выучили материал:
1. Обучает на одной половине примеров
2. Проверяет на другой половине
3. Смотрит, насколько ошибались
4. Использует эту информацию для новых прогнозов

**Плюс**: Очень простой
**Минус**: Интервал одинаковый для всех ситуаций

### 2. Квантильная регрессия (CQR) — умнее

**Аналогия: Опытный врач**

Врач знает, что:
- Молодые пациенты выздоравливают быстрее и предсказуемее
- Пожилые пациенты выздоравливают медленнее и менее предсказуемо

Он даёт разные прогнозы разным пациентам!

Так же CQR даёт:
- Узкие интервалы когда ситуация предсказуемая
- Широкие интервалы когда ситуация непредсказуемая

### 3. Адаптивный (ACI) — для изменяющегося мира

**Аналогия: Термостат в доме**

Термостат постоянно следит за температурой:
- Слишком жарко → включает охлаждение
- Слишком холодно → включает обогрев

ACI постоянно следит за своими ошибками:
- Слишком часто ошибается → расширяет интервалы
- Редко ошибается → сужает интервалы

---

## Сравнение с обычным подходом

### Обычная модель (как самоуверенный студент)

```
День 1: "Цена вырастет на 5%!" → Реально: упала на 2% (ОШИБКА)
День 2: "Цена упадёт на 3%!" → Реально: выросла на 1% (ОШИБКА)
День 3: "Цена вырастет на 2%!" → Реально: выросла на 3% (почти)
```

Проблема: Модель всегда уверена, но часто ошибается. Трейдер торгует каждый день и теряет деньги.

### Конформное предсказание (как мудрый студент)

```
День 1: "Не знаю, интервал слишком широкий" → НЕ ТОРГУЕМ
День 2: "Не знаю, интервал слишком широкий" → НЕ ТОРГУЕМ
День 3: "Вырастет на 2-4%, интервал узкий!" → ТОРГУЕМ → ПРИБЫЛЬ!
```

Результат: Торгуем реже, но когда торгуем — зарабатываем!

---

## Практический пример: Торговля Bitcoin

### Шаг 1: Собираем данные

Берём историю цен Bitcoin за последний год:
- Цены закрытия
- Объёмы торгов
- Технические индикаторы (RSI, Moving Average и др.)

### Шаг 2: Готовим признаки

Создаём «подсказки» для модели:
- Изменение цены за последние 24 часа
- Средняя цена за 7 дней
- Насколько волатилен рынок сейчас

### Шаг 3: Обучаем и калибруем

```python
# Разделяем данные
train_data = данные[:6_месяцев]   # Для обучения
calib_data = данные[6:9_месяцев]  # Для калибровки
test_data = данные[9_месяцев:]    # Для проверки

# Обучаем модель
model.fit(train_data)

# Калибруем (находим "запас прочности")
ошибки = model.predict(calib_data) - реальные_значения
запас = percentile(|ошибки|, 90)  # 90% покрытие
```

### Шаг 4: Торгуем

```python
для каждого дня в test_data:
    предсказание = model.predict(сегодняшние_данные)

    нижняя_граница = предсказание - запас
    верхняя_граница = предсказание + запас
    ширина = верхняя_граница - нижняя_граница

    если ширина > 5%:
        пропускаем("Слишком неуверенно")

    иначе если нижняя_граница > 0.5%:
        покупаем(размер = 1/ширина)

    иначе если верхняя_граница < -0.5%:
        продаём(размер = 1/ширина)

    иначе:
        пропускаем("Направление неясно")
```

---

## Ключевые метрики успеха

### 1. Покрытие (Coverage)
**Что это**: Как часто реальная цена попадает в наш интервал
**Хорошо**: Близко к целевому (например, 90%)
**Плохо**: Сильно отличается от целевого

### 2. Ширина интервала
**Что это**: Насколько широки наши интервалы
**Хорошо**: Узкие (мы уверены)
**Плохо**: Слишком широкие (мы не знаем ничего)

### 3. Шарп (Sharpe Ratio)
**Что это**: Доходность делённая на риск
**Хорошо**: > 1 (хорошая стратегия)
**Отлично**: > 2 (отличная стратегия)

### 4. Процент выигрышей (Win Rate)
**Что это**: Сколько сделок прибыльных
**Хорошо**: > 50%
**С конформным предсказанием**: Обычно 55-65%

---

## Почему это работает?

### Причина 1: Избегаем плохие сделки

Представь, что из 100 возможных сделок:
- 30 были бы прибыльными
- 70 были бы убыточными

Обычная стратегия делает все 100 сделок и теряет деньги.

Конформное предсказание:
- Видит, что 70 сделок «неуверенные»
- Пропускает их
- Делает только 30 «уверенных» сделок
- Из них большинство прибыльные!

### Причина 2: Правильный размер позиции

Даже если мы не всегда правы:
- На уверенных сделках ставим много → получаем много
- На неуверенных ставим мало → теряем мало

В сумме зарабатываем больше, чем теряем!

---

## Что дальше?

### Для начинающих
1. Попробуй простой пример из `rust_examples/`
2. Поиграй с разными значениями покрытия (80%, 90%, 95%)
3. Посмотри, как меняется ширина интервала

### Для продвинутых
1. Изучи CQR для адаптивных интервалов
2. Попробуй ACI для нестационарных рынков
3. Комбинируй с другими стратегиями

---

## Главные выводы

1. **Честность важнее точности** — лучше сказать «не знаю», чем ошибиться
2. **Торгуй только когда уверен** — пропускай сомнительные сделки
3. **Размер зависит от уверенности** — чем увереннее, тем больше позиция
4. **Гарантии работают** — если целишься на 90%, получишь около 90%

---

## Аналогия на прощание: Мудрый игрок в покер

Профессиональный игрок в покер не играет каждую руку. Он:
- Смотрит на свои карты
- Оценивает шансы
- Если карты хорошие и он **уверен** — делает большую ставку
- Если карты плохие или он **не уверен** — сбрасывает

Конформное предсказание даёт твоей торговой модели такую же мудрость!

**Торгуй как профессионал: только когда уверен!**

# Рыночные и фундаментальные данные: Источники и методы

Данные всегда были важнейшим драйвером торговли, и трейдеры давно прилагают усилия, чтобы получить преимущество от доступа к превосходной информации. Эти усилия восходят, по крайней мере, к слухам о том, что дом Ротшильдов получил большую прибыль от покупки облигаций благодаря предварительным новостям о победе Британии при Ватерлоо, доставленным голубями через канал.

Сегодня инвестиции в более быстрый доступ к данным принимают форму консорциума Go West ведущих фирм **высокочастотной торговли** (HFT), который соединяет Чикагскую товарную биржу (CME) с Токио. Задержка между CME и биржами BATS в Нью-Йорке снизилась почти до теоретического минимума в восемь миллисекунд, поскольку трейдеры конкурируют за использование арбитражных возможностей. В то же время регуляторы и биржи начали вводить "лежачих полицейских", которые замедляют торговлю, чтобы ограничить негативное влияние на конкуренцию неравного доступа к информации.

Традиционно инвесторы в основном полагались на **общедоступные рыночные и фундаментальные данные**. Усилия по созданию или приобретению частных наборов данных, например, с помощью собственных опросов, были ограничены. Традиционные стратегии сосредоточены на фундаментальных показателях акций и строят финансовые модели на основе отчетных финансовых показателей, возможно, в сочетании с отраслевыми или макроданными для прогнозирования прибыли на акцию и цен акций. Альтернативно, они используют технический анализ для извлечения сигналов из рыночных данных с использованием индикаторов, рассчитанных на основе информации о цене и объеме.

**Алгоритмы машинного обучения (ML)** обещают использовать рыночные и фундаментальные данные более эффективно, чем определенные человеком правила и эвристики, особенно в сочетании с альтернативными данными, темой следующей главы. Мы покажем, как применять алгоритмы машинного обучения, от линейных моделей до рекуррентных нейронных сетей (RNN), к рыночным и фундаментальным данным и генерировать торговые сигналы.

Эта глава знакомит с источниками рыночных и фундаментальных данных и объясняет, как они отражают среду, в которой они создаются. Детали **торговой среды** важны не только для правильной интерпретации рыночных данных, но и для разработки и выполнения вашей стратегии, а также для реализации реалистичных симуляций бэктестинга. Мы также иллюстрируем, как получать доступ и работать с торговыми данными и данными финансовой отчетности из различных источников с использованием Python.

## Содержание

1. [Рыночные данные отражают торговую среду](#рыночные-данные-отражают-торговую-среду)
    * [Рыночная микроструктура: основы торговли](#рыночная-микроструктура-основы-торговли)
2. [Работа с высокочастотными рыночными данными](#работа-с-высокочастотными-рыночными-данными)
    * [Как работать с данными книги ордеров NASDAQ](#как-работать-с-данными-книги-ордеров-nasdaq)
    * [Как передаются сделки: протокол FIX](#как-передаются-сделки-протокол-fix)
    * [Поток данных NASDAQ TotalView-ITCH](#поток-данных-nasdaq-totalview-itch)
        - [Пример кода: Парсинг и нормализация тиковых данных](#пример-кода-парсинг-и-нормализация-тиковых-данных)
        - [Дополнительные ресурсы](#дополнительные-ресурсы)
    * [Минутные бары AlgoSeek: данные котировок и сделок по акциям](#минутные-бары-algoseek-данные-котировок-и-сделок-по-акциям)
        - [От консолидированного потока к минутным барам](#от-консолидированного-потока-к-минутным-барам)
        - [Пример кода: Как обрабатывать внутридневные данные AlgoSeek](#пример-кода-как-обрабатывать-внутридневные-данные-algoseek)
3. [API доступ к рыночным данным](#api-доступ-к-рыночным-данным)
    * [Удаленный доступ к данным с использованием pandas](#удаленный-доступ-к-данным-с-использованием-pandas)
    * [Примеры кода](#примеры-кода)
    * [Источники данных](#источники-данных)
    * [Отраслевые новости](#отраслевые-новости)
4. [Как работать с фундаментальными данными](#как-работать-с-фундаментальными-данными)
    * [Данные финансовой отчетности](#данные-финансовой-отчетности)
    * [Автоматическая обработка с использованием разметки XBRL](#автоматическая-обработка-с-использованием-разметки-xbrl)
    * [Пример кода: Построение временного ряда фундаментальных данных](#пример-кода-построение-временного-ряда-фундаментальных-данных)
    * [Другие источники фундаментальных данных](#другие-источники-фундаментальных-данных)
5. [Эффективное хранение данных с pandas](#эффективное-хранение-данных-с-pandas)
    * [Пример кода](#пример-кода)

## Рыночные данные отражают торговую среду

Рыночные данные — это продукт того, как трейдеры размещают ордера на финансовый инструмент напрямую или через посредников на одной из многочисленных торговых площадок, и как они обрабатываются, и как устанавливаются цены путем сопоставления спроса и предложения. В результате данные отражают институциональную среду торговых площадок, включая правила и нормы, регулирующие ордера, исполнение сделок и формирование цен. См. [Harris](https://global.oup.com/ushe/product/trading-and-exchanges-9780195144703?cc=us&lang=en&) (2003) для глобального обзора и [Jones](https://www0.gsb.columbia.edu/faculty/cjones/papers/2018.08.31%20US%20Equity%20Market%20Data%20Paper.pdf) (2018) для деталей по рынку США.

Алгоритмические трейдеры используют алгоритмы, включая ML, для анализа потока ордеров на покупку и продажу, а также результирующей статистики объема и цен для извлечения торговых сигналов, которые фиксируют инсайты, например, о динамике спроса и предложения или поведении определенных участников рынка. Этот раздел рассматривает институциональные особенности, влияющие на симуляцию торговой стратегии во время бэктеста, прежде чем мы начнем работать с фактическими тиковыми данными, созданными одной такой средой, а именно NASDAQ.

### Рыночная микроструктура: основы торговли

Рыночная микроструктура изучает, как институциональная среда влияет на процесс торговли и формирует такие результаты, как ценообразование, спреды спроса и предложения и котировки, внутридневное торговое поведение и транзакционные издержки. Это одна из самых быстрорастущих областей финансовых исследований, движимая быстрым развитием алгоритмической и электронной торговли.

Сегодня хедж-фонды спонсируют внутренних аналитиков для отслеживания быстро развивающихся сложных деталей и обеспечения исполнения по наилучшим возможным рыночным ценам, а также разработки стратегий, использующих рыночные трения. Этот раздел дает краткий обзор ключевых концепций, а именно различных торговых площадок и типов ордеров, прежде чем мы погрузимся в данные, генерируемые торговлей.

- [Trading and Exchanges - Market Microstructure for Practitioners](https://global.oup.com/ushe/product/trading-and-exchanges-9780195144703?cc=us&lang=en&), Larry Harris, Oxford University Press, 2003
- [Understanding the Market for Us Equity Market Data](https://www0.gsb.columbia.edu/faculty/cjones/papers/2018.08.31%20US%20Equity%20Market%20Data%20Paper.pdf), Charles Jones, NYSE, 2018
- [World Federation of Exchanges](https://www.world-exchanges.org/our-work/statistics)
- [Econophysics of Order-driven Markets](https://www.springer.com/gp/book/9788847017658), Abergel et al, 2011
    - Представляет идеи и исследования различных сообществ (физиков, экономистов, математиков, финансовых инженеров) по моделированию и анализу рынков, управляемых ордерами. Основной интерес в этих исследованиях представляют механизмы, приводящие к статистическим закономерностям ценовой статистики. Также представлены результаты, относящиеся к другим важным вопросам, таким как влияние на рынок, прибыльность торговых стратегий или математические модели для эффектов микроструктуры.

## Работа с высокочастотными рыночными данными

Две категории рыночных данных охватывают тысячи компаний, котирующихся на биржах США, которые торгуются в соответствии с Reg NMS: консолидированный поток объединяет данные о сделках и котировках с каждой торговой площадки, тогда как каждая отдельная биржа предлагает собственные продукты с дополнительной информацией о активности для данной конкретной площадки.

В этом разделе мы сначала представим проприетарные данные о потоке ордеров, предоставляемые NASDAQ, которые представляют собой фактический поток ордеров, сделок и результирующих цен по мере их возникновения на тик-за-тиком основе. Затем мы демонстрируем, как регуляризовать этот непрерывный поток данных, поступающий с нерегулярными интервалами, в бары фиксированной продолжительности. Наконец, мы представляем данные минутных баров акций AlgoSeek, которые содержат консолидированную информацию о сделках и котировках. В каждом случае мы иллюстрируем, как работать с данными с использованием Python, чтобы вы могли использовать эти источники для своей торговой стратегии.

### Как работать с данными книги ордеров NASDAQ

Основным источником рыночных данных является книга ордеров, которая обновляется в режиме реального времени в течение дня, чтобы отражать всю торговую активность. Биржи обычно предлагают эти данные в виде услуги в режиме реального времени за плату, но могут предоставлять некоторые исторические данные бесплатно.

В Соединенных Штатах фондовые рынки предоставляют котировки на трех уровнях, а именно Уровень I, II и III, которые предлагают все более детализированную информацию и возможности:
- Уровень I: информация о ценах покупки и продажи в реальном времени, доступная из многочисленных онлайн-источников
- Уровень II: добавляет информацию о ценах покупки и продажи от конкретных маркет-мейкеров, а также о размере и времени недавних транзакций для лучшего понимания ликвидности данной акции.
- Уровень III: добавляет возможность вводить или изменять котировки, исполнять ордера и подтверждать сделки и доступен только маркет-мейкерам и фирмам-членам биржи. Доступ к котировкам Уровня III позволяет зарегистрированным брокерам соответствовать требованиям наилучшего исполнения.

Торговая активность отражается в многочисленных сообщениях о ордерах, отправляемых участниками рынка. Эти сообщения обычно соответствуют электронному протоколу коммуникации Financial Information eXchange (FIX) для обмена сделками с ценными бумагами и рыночными данными в режиме реального времени или собственному протоколу биржи.

- [The Limit Order Book](https://arxiv.org/pdf/1012.0349.pdf)
- [Feature Engineering for Mid-Price Prediction With Deep Learning](https://arxiv.org/abs/1904.05384)
- [Price jump prediction in Limit Order Book](https://arxiv.org/pdf/1204.1381.pdf)
- [Handling and visualizing order book data](https://github.com/0b01/recurrent-autoencoder/blob/master/Visualizing%20order%20book.ipynb) by Ricky Han

### Как передаются сделки: протокол FIX

Торговая активность отражается в многочисленных сообщениях о торговых ордерах, отправляемых участниками рынка. Эти сообщения обычно соответствуют электронному протоколу коммуникации Financial Information eXchange (FIX) для обмена сделками с ценными бумагами и рыночными данными в режиме реального времени или собственному протоколу биржи.

- [FIX Trading Standards](https://www.fixtrading.org/standards/)
- Python: [Simplefix](https://github.com/da4089/simplefix)
- C++ версия: [quickfixengine](http://www.quickfixengine.org/)
- Интерфейс Interactive Brokers [interface](https://www.interactivebrokers.com/en/index.php?f=4988)

### Поток данных NASDAQ TotalView-ITCH

Хотя FIX имеет доминирующую долю большого рынка, биржи также предлагают собственные протоколы. Nasdaq предлагает прямой протокол потока данных TotalView ITCH, который позволяет подписчикам отслеживать отдельные ордера на долевые инструменты от размещения до исполнения или отмены.

- [Спецификации](http://www.nasdaqtrader.com/content/technicalsupport/specifications/dataproducts/NQTVITCHspecification.pdf) ITCH
- [Примеры файлов](ftp://emi.nasdaq.com/ITCH/)

#### Пример кода: Парсинг и нормализация тиковых данных

- Папка [NASDAQ TotalView ITCH Order Book](01_NASDAQ_TotalView-ITCH_Order_Book) содержит ноутбуки для:
    - загрузки примеров тиковых данных NASDAQ Total View,
    - парсинга сообщений из бинарных исходных данных
    - реконструкции книги ордеров для данной акции
    - визуализации данных потока ордеров
    - нормализации тиковых данных
- Сервисы бинарных данных: модуль `struct` [module](https://docs.python.org/3/library/struct.html)

#### Дополнительные ресурсы

- Собственные протоколы бирж [по всему миру](https://en.wikipedia.org/wiki/List_of_electronic_trading_protocols)
- [High-frequency trading in a limit order book](https://www.math.nyu.edu/faculty/avellane/HighFrequencyTrading.pdf), Avellaneda and Stoikov, Quantitative Finance, Vol. 8, No. 3, April 2008, 217–224
- [Using a Simulator to Develop Execution Algorithms](http://www.math.ualberta.ca/~cfrei/PIMS/Almgren5.pdf), Robert Almgren, quantitative brokers, 2016
- [Backtesting Microstructure Strategies](https://rickyhan.com/jekyll/update/2019/12/22/how-to-simulate-market-microstructure.html), Ricky Han, 2019
- [Optimal High-Frequency Market Making](http://stanford.edu/class/msande448/2018/Final/Reports/gr5.pdf), Fushimi et al, 2018
- [Simulating and analyzing order book data: The queue-reactive model](https://arxiv.org/pdf/1312.0563.pdf), Huan et al, 2014
- [How does latent liquidity get revealed in the limit order book?](https://arxiv.org/pdf/1808.09677.pdf), Dall'Amico et al, 2018

### Минутные бары AlgoSeek: данные котировок и сделок по акциям

AlgoSeek предоставляет исторические внутридневные данные того качества, которое ранее было доступно только институциональным инвесторам. Бары акций AlgoSeek предоставляют очень подробные внутридневные данные о котировках и сделках в удобном для пользователя формате, предназначенном для облегчения разработки и бэктестинга внутридневных стратегий, управляемых ML. Как мы увидим, данные включают не только информацию OHLCV, но и информацию о спреде спроса и предложения, а также количество тиков с движениями цен вверх и вниз, среди прочего.

AlgoSeek любезно предоставил образцы данных минутных баров для акций NASDAQ 100 с 2013-2017 для демонстрационных целей и сделает подмножество этих данных доступным для читателей этой книги.

#### От консолидированного потока к минутным барам

Минутные бары AlgoSeek основаны на данных, предоставленных процессором информации о ценных бумагах (SIP), который управляет консолидированным потоком, упомянутым в начале этого раздела. Вы можете найти документацию на https://www.algoseek.com/data-drive.html.

**Поля данных котировок и сделок**

Данные минутных баров содержат до 54 полей. Есть восемь полей для элементов открытия, максимума, минимума и закрытия бара, а именно:
- Временная метка для бара и соответствующей сделки
- Цена и размер для преобладающей котировки спроса и предложения и соответствующей сделки

Также есть 14 точек данных с информацией об объеме за период бара:
- Количество акций и соответствующих сделок
- Объемы торгов на уровне или ниже цены спроса, между котировкой спроса и средней точкой, на средней точке, между средней точкой и котировкой предложения, и на уровне или выше цены предложения, а также для кроссов
- Количество акций, торгуемых с повышением или понижением, т.е. когда цена выросла или упала, а также когда цена не изменилась, дифференцированная по предыдущему направлению движения цены

#### Пример кода: Как обрабатывать внутридневные данные AlgoSeek

Директория [algoseek_intraday](02_algoseek_intraday) содержит инструкции о том, как загрузить образцы данных от AlgoSeek.

- Эта информация будет доступна в ближайшее время.

## API доступ к рыночным данным

Существует несколько вариантов доступа к рыночным данным через API с использованием Python. В этой главе мы сначала представляем несколько источников, встроенных в библиотеку [`pandas`](https://pandas.pydata.org/). Затем мы кратко представляем торговую платформу [Quantopian](https://www.quantopian.com/posts), поставщика данных [Quandl](https://www.quandl.com/) (приобретен NASDAQ в 12/2018) и библиотеку бэктестинга [`zipline`](https://github.com/quantopian/zipline), которую мы будем использовать позже в книге, и перечисляем несколько дополнительных вариантов для доступа к различным типам рыночных данных. Директория [data_providers](03_data_providers) содержит несколько ноутбуков, иллюстрирующих использование этих вариантов.

### Удаленный доступ к данным с использованием pandas

- read_html [документация](https://pandas.pydata.org/pandas-docs/stable/)
- Составляющие S&P 500 из [Wikipedia](https://en.wikipedia.org/wiki/List_of_S%26P_500_companies)
- `pandas-datareader` [документация](https://pandas-datareader.readthedocs.io/en/latest/index.html)

### Примеры кода

Папка [data providers](03_data_providers) содержит примеры использования различных поставщиков данных.
1. Удаленный доступ к данным с использованием [pandas DataReader](03_data_providers/01_pandas_datareader_demo.ipynb)
2. Загрузка рыночных и фундаментальных данных с [yfinance](03_data_providers/02_yfinance_demo.ipynb)
3. Парсинг тиковых данных лимитных ордеров от [LOBSTER](03_data_providers/03_lobster_itch_data.ipynb)
4. Демо API [Quandl](03_data_providers/04_quandl_demo.ipynb)
5. Доступ к данным [Zipline](03_data_providers/05_zipline_data_demo.ipynb)

### Источники данных

- Quandl [документация](https://docs.quandl.com/docs) и Python [API](https://www.quandl.com/tools/python﻿)
- [yfinance](https://github.com/ranaroussi/yfinance)
- [Quantopian](https://www.quantopian.com/posts)
- [Zipline](https://zipline.ml4trading.io/﻿)
- [LOBSTER](https://lobsterdata.com/)
- [The Investor Exchange](https://iextrading.com/﻿)
- [IEX Cloud](https://iexcloud.io/) инфраструктура финансовых данных
- [Money.net](https://www.money.net/)
- [Trading Economic](https://tradingeconomics.com/)
- [Barchart](https://www.barchart.com/)
- [Alpha Vantage](https://www.alphavantage.co/﻿)
- [Alpha Trading Labs](https://www.alphatradinglabs.com/)
- [Tiingo](https://www.tiingo.com/) инструменты фондового рынка

### Отраслевые новости

- [Bloomberg and Reuters lose data share to smaller rivals](https://www.ft.com/content/622855dc-2d31-11e8-9b4b-bc4b9f08f381), FT, 2018

## Как работать с фундаментальными данными

Фундаментальные данные относятся к экономическим драйверам, которые определяют стоимость ценных бумаг. Характер данных зависит от класса активов:
- Для акций и корпоративного кредита это включает корпоративную финансовую отчетность, а также данные по отрасли и экономике в целом.
- Для государственных облигаций это включает международные макроданные и валютный обмен.
- Для сырьевых товаров это включает специфические для актива детерминанты спроса и предложения, такие как погодные данные для зерновых культур.

Мы сосредоточимся на фундаментальных показателях акций для США, где доступ к данным проще. В мире насчитывается около 13 000+ публичных компаний, которые создают 2 миллиона страниц годовых отчетов и 30 000+ часов звонков о прибылях. В алгоритмической торговле фундаментальные данные и признаки, созданные из этих данных, могут использоваться для получения торговых сигналов напрямую, например, в качестве индикаторов стоимости, и являются существенным входом для прогнозных моделей, включая модели машинного обучения.

### Данные финансовой отчетности

Комиссия по ценным бумагам и биржам (SEC) требует от эмитентов США, то есть котирующихся компаний и ценных бумаг, включая взаимные фонды, подавать три квартальные финансовые отчетности (форма 10-Q) и один годовой отчет (форма 10-K), в дополнение к различным другим требованиям регуляторной отчетности.

С начала 1990-х годов SEC сделала эти отчеты доступными через свою систему электронного сбора, анализа и поиска данных (EDGAR). Они представляют собой основной источник данных для фундаментального анализа акций и других ценных бумаг, таких как корпоративный кредит, где стоимость зависит от деловых перспектив и финансового здоровья эмитента.

### Автоматическая обработка с использованием разметки XBRL

Автоматический анализ регуляторных отчетов стал намного проще с тех пор, как SEC представила XBRL, бесплатный, открытый и глобальный стандарт для электронного представления и обмена бизнес-отчетами. XBRL основан на XML; он опирается на [таксономии](https://www.sec.gov/dera/data/edgar-log-file-data-set.html), которые определяют значение элементов отчета и сопоставляются с тегами, которые выделяют соответствующую информацию в электронной версии отчета. Одна такая таксономия представляет общепринятые принципы бухгалтерского учета США (GAAP).

SEC ввела добровольные отчеты XBRL в 2005 году в ответ на бухгалтерские скандалы, прежде чем потребовать этот формат для всех подающих с 2009 года, и продолжает расширять обязательное покрытие на другие регуляторные отчеты. SEC поддерживает веб-сайт, на котором перечислены текущие таксономии, которые формируют содержание различных отчетов и могут использоваться для извлечения конкретных элементов.

Существует несколько путей для отслеживания и доступа к фундаментальным данным, сообщаемым в SEC:
- В рамках [службы публичного распространения EDGAR](https://www.sec.gov/oit/announcement/public-dissemination-service-system-contact.html) (PDS) электронные потоки принятых отчетов доступны за плату.
- SEC обновляет [RSS-каналы](https://www.sec.gov/structureddata/rss-feeds-submitted-filings) каждые 10 минут, которые перечисляют представления структурированных раскрытий.
- Существуют публичные [индексные файлы](https://www.sec.gov/edgar/searchedgar/accessing-edgar-data.htm) для получения всех отчетов через FTP для автоматической обработки.
- Наборы данных финансовых отчетов (и примечаний) содержат разобранные данные XBRL из всех финансовых отчетов и сопровождающих примечаний.

SEC также публикует файлы журналов, содержащие [интернет-трафик поиска](https://www.sec.gov/dera/data/edgar-log-file-data-set.html) для отчетов EDGAR через SEC.gov, хотя и с шестимесячной задержкой.

### Пример кода: Построение временного ряда фундаментальных данных

Область данных в наборах данных [Финансовых отчетов и примечаний](https://www.sec.gov/dera/data/financial-statement-and-notes-data-set.html) состоит из числовых данных, извлеченных из основных финансовых отчетов (баланс, отчет о прибылях и убытках, потоки денежных средств, изменения в капитале и совокупный доход) и сносок к этим отчетам. Данные доступны с 2009 года.

Папка [04_sec_edgar](04_sec_edgar) содержит ноутбук [edgar_xbrl](04_sec_edgar/edgar_xbrl.ipynb) для загрузки и парсинга данных EDGAR в формате XBRL и создания фундаментальных метрик, таких как коэффициент P/E, путем объединения данных финансовой отчетности и цен.

### Другие источники фундаментальных данных

- [Компиляция макроресурсов юридической школой Йеля](https://library.law.yale.edu/news/75-sources-economic-data-statistics-reports-and-commentary)
- [Capital IQ](www.capitaliq.com)
- [Compustat](www.compustat.com)
- [MSCI Barra](www.mscibarra.com)
- [Northfield Information Services](www.northinfo.com)
- [Quantitative Services Group](www.qsg.com)

## Эффективное хранение данных с pandas

Мы будем использовать много различных наборов данных в этой книге, и стоит сравнить основные форматы по эффективности и производительности. В частности, мы сравниваем следующие:

- **CSV**: текстовый файл со значениями, разделенными запятыми, стандартный плоский формат текстового файла.
- **HDF5**: иерархический формат данных, первоначально разработанный в Национальном центре суперкомпьютинга, представляет собой быстрый и масштабируемый формат хранения для числовых данных, доступный в pandas с использованием библиотеки PyTables.
- **Parquet**: бинарный столбцовый формат хранения, часть экосистемы Apache Hadoop, который обеспечивает эффективное сжатие и кодирование данных и был разработан Cloudera и Twitter. Он доступен для pandas через библиотеку pyarrow, возглавляемую Уэсом Маккинни, первоначальным автором pandas.

### Пример кода

Ноутбук [storage_benchmark](05_storage_benchmark/storage_benchmark.ipynb) в директории [05_storage_benchmark](05_storage_benchmark) сравнивает производительность вышеуказанных библиотек.

# Работа с рыночными данными: Книга ордеров NASDAQ TotalView-ITCH

Хотя FIX имеет доминирующую большую долю рынка, биржи также предлагают собственные протоколы. Nasdaq предлагает прямой протокол потока данных TotalView ITCH, который позволяет подписчикам отслеживать отдельные ордера на долевые инструменты от размещения до исполнения или отмены.

В результате это позволяет реконструировать книгу ордеров, которая отслеживает список активных лимитных ордеров на покупку и продажу для конкретной ценной бумаги или финансового инструмента. Книга ордеров раскрывает глубину рынка в течение дня, перечисляя количество акций, предлагаемых на покупку или продажу по каждой ценовой точке. Она также может идентифицировать участника рынка, ответственного за конкретные ордера на покупку и продажу, если только они не размещены анонимно. Глубина рынка является ключевым индикатором ликвидности и потенциального влияния на цену крупных рыночных ордеров.

В дополнение к сопоставлению рыночных и лимитных ордеров, Nasdaq также проводит аукционы или кроссы, которые исполняют большое количество сделок при открытии и закрытии рынка. Кроссы становятся все более важными, поскольку пассивное инвестирование продолжает расти, и трейдеры ищут возможности для исполнения более крупных блоков акций. TotalView также распространяет индикатор чистого дисбаланса ордеров (NOII) для открывающих и закрывающих кроссов Nasdaq и IPO/Halt кросса Nasdaq.

> Этот пример требует много памяти, вероятно, более 16 ГБ (я использую 64 ГБ и еще не проверял минимальное требование). Если вы столкнетесь с ограничениями по мощности, имейте в виду, что это не является существенным для всего остального в этой книге, чтобы вы могли запустить код. Прежде всего, он нацелен на демонстрацию того, с каким типом данных вы бы работали в контексте институциональных инвестиций, где системы были бы построены для управления данными, намного большими, чем этот однодневный пример.

## Парсинг бинарных сообщений ITCH

Спецификация ITCH v5.0 объявляет более 20 типов сообщений, связанных с системными событиями, характеристиками акций, размещением и модификацией лимитных ордеров и исполнением сделок. Она также содержит информацию о чистом дисбалансе ордеров перед открывающим и закрывающим кроссом.

Nasdaq предлагает образцы ежедневных бинарных файлов за несколько месяцев. Репозиторий GitHub для этой главы содержит ноутбук build_order_book.ipynb, который иллюстрирует, как парсить образец файла сообщений ITCH и реконструировать как исполненные сделки, так и книгу ордеров для любого заданного тика.

Следующая таблица показывает частоту наиболее распространенных типов сообщений для образца файла, используемого в книге (датированного 29 марта 2018 года). Код тем временем обновлен для использования нового образца от 27 марта 2019 года.

| Тип сообщения | Влияние на книгу ордеров                                                          | Количество сообщений |
|:-------------:|-----------------------------------------------------------------------------------|---------------------:|
| A             | Новый неатрибутированный лимитный ордер                                           | 136,522,761          |
| D             | Ордер отменен                                                                     | 133,811,007          |
| U             | Ордер отменен и заменен                                                           | 21,941,015           |
| E             | Полное или частичное исполнение; возможно несколько сообщений для одного ордера  | 6,687,379            |
| X             | Изменен после частичной отмены                                                    | 5,088,959            |
| F             | Добавить атрибутированный ордер                                                   | 2,718,602            |
| P             | Торговое сообщение (не-кросс)                                                     | 1,120,861            |
| C             | Исполнено полностью или частично по цене, отличной от начальной отображаемой     | 157,442              |
| Q             | Сообщение о кросс-сделке                                                          | 17,233               |

Для каждого сообщения спецификация определяет компоненты и их соответствующую длину и типы данных:

| Название                      | Смещение | Длина | Значение   | Примечания                                                                                      |
|-------------------------------|----------|-------|------------|-------------------------------------------------------------------------------------------------|
| Тип сообщения                 | 0        | 1     | S          | Сообщение о системном событии                                                                   |
| Локация акции                 | 1        | 2     | Integer    | Всегда 0                                                                                        |
| Номер отслеживания            | 3        | 2     | Integer    | Внутренний номер отслеживания Nasdaq                                                            |
| Временная метка               | 5        | 6     | Integer    | Наносекунды с полуночи                                                                          |
| Номер ссылки ордера           | 11       | 8     | Integer    | Уникальный номер ссылки, присвоенный новому ордеру при получении                               |
| Индикатор покупки/продажи     | 19       | 1     | Alpha      | Тип добавляемого ордера. B = Ордер на покупку. S = Ордер на продажу                            |
| Акции                         | 20       | 4     | Integer    | Общее количество акций, связанных с ордером, добавляемым в книгу                               |
| Акция                         | 24       | 8     | Alpha      | Символ акции, дополненный справа пробелами                                                      |
| Цена                          | 32       | 4     | Price (4)  | Отображаемая цена нового ордера. См. типы данных для примечаний по обработке полей             |
| Атрибуция                     | 36       | 4     | Alpha      | Идентификатор участника рынка Nasdaq, связанный с введенным ордером                             |

Ноутбуки [01_build_itch_order_book](01_parse_itch_order_flow_messages.ipynb), [02_rebuild_nasdaq_order_book](02_rebuild_nasdaq_order_book.ipynb) и [03_normalize_tick_data](03_normalize_tick_data.ipynb) содержат код для:
- загрузки образцов тиковых данных NASDAQ Total View,
- парсинга сообщений из бинарных исходных данных
- реконструкции книги ордеров для данной акции
- визуализации данных потока ордеров
- нормализации тиковых данных

Код был обновлен для использования последнего образца файла NASDAQ от 27 марта 2019 года.

Предупреждение: тиковые данные имеют размер около 12 ГБ, и некоторые этапы обработки могут занять несколько часов на 4-ядерном процессоре i7 с 32 ГБ ОЗУ.

## Регуляризация тиковых данных

Торговые данные индексируются наносекундами и очень шумные. Отскок спроса-предложения, например, заставляет цену колебаться между ценами спроса и предложения, когда инициация сделки чередуется между рыночными ордерами на покупку и продажу. Чтобы улучшить соотношение шума и сигнала и улучшить статистические свойства, нам нужно пересэмплировать и регуляризовать тиковые данные путем агрегации торговой активности.

Мы обычно собираем цену открытия (первую), минимум, максимум и цену закрытия (последнюю) для агрегированного периода, наряду со средневзвешенной по объему ценой (VWAP), количеством проторгованных акций и временной меткой, связанной с данными.

Ноутбук [03_normalize_tick_data](03_normalize_tick_data.ipynb) иллюстрирует, как нормализовать шумные тики, используя временные и объемные бары, которые используют различные методы агрегации.

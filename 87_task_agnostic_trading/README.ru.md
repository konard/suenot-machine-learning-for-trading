# Глава 87: Задаче-Агностический Трейдинг

## Обзор

Задаче-агностический трейдинг разрабатывает универсальные модели, которые хорошо работают для множества торговых задач без специфической настройки под конкретную задачу. В отличие от традиционных подходов, которые обучают отдельные модели для прогнозирования цены, волатильности, определения режима рынка и оптимизации портфеля, задаче-агностические модели изучают общие представления, которые эффективно переносятся на любую последующую задачу.

## Содержание

1. [Введение](#введение)
2. [Теоретические основы](#теоретические-основы)
3. [Задаче-агностические архитектуры](#задаче-агностические-архитектуры)
4. [Универсальное обучение признаков](#универсальное-обучение-признаков)
5. [Стратегия мультизадачного обучения](#стратегия-мультизадачного-обучения)
6. [Применение в трейдинге](#применение-в-трейдинге)
7. [Интеграция с Bybit](#интеграция-с-bybit)
8. [Реализация](#реализация)
9. [Управление рисками](#управление-рисками)
10. [Метрики производительности](#метрики-производительности)
11. [Ссылки](#ссылки)

---

## Введение

Традиционное машинное обучение для трейдинга сталкивается с фундаментальной проблемой: модели обычно специфичны для конкретной задачи. Модель, обученная для прогнозирования направления цены, не может напрямую использоваться для прогнозирования волатильности или определения режима рынка. Это требует поддержки множества моделей, каждая со своим конвейером обучения, гиперпараметрами и накладными расходами на обслуживание.

### Проблема задаче-специфичных моделей

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Традиционный задаче-специфичный подход                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ОТДЕЛЬНЫЕ МОДЕЛИ ДЛЯ КАЖДОЙ ЗАДАЧИ:                                       │
│   ────────────────────────────────────                                      │
│                                                                              │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐          │
│   │   Предсказание  │   │   Прогноз       │   │   Детектор      │          │
│   │   Направления   │   │   Волатильности │   │   Режима        │          │
│   ├─────────────────┤   ├─────────────────┤   ├─────────────────┤          │
│   │ • Свои признаки │   │ • Свои признаки │   │ • Свои признаки │          │
│   │ • Своё обучение │   │ • Своё обучение │   │ • Своё обучение │          │
│   │ • Своя настройка│   │ • Своя настройка│   │ • Своя настройка│          │
│   │ • Свой деплой   │   │ • Свой деплой   │   │ • Свой деплой   │          │
│   └─────────────────┘   └─────────────────┘   └─────────────────┘          │
│                                                                              │
│   Проблемы:                                                                  │
│   • 3× усилий на разработку                                                 │
│   • 3× накладных расходов на поддержку                                      │
│   • Нет обмена знаниями между задачами                                      │
│   • Несогласованные предсказания между задачами                             │
│   • Каждая модель переобучается под свою задачу                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Задаче-агностическое решение

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Задаче-агностический унифицированный подход               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ЕДИНАЯ УНИВЕРСАЛЬНАЯ МОДЕЛЬ:                                              │
│   ────────────────────────────                                              │
│                                                                              │
│                      ┌─────────────────────────┐                            │
│                      │   Универсальный Энкодер │                            │
│                      │   (Общая основа)        │                            │
│                      ├─────────────────────────┤                            │
│                      │ • Рыночное представление│                            │
│                      │ • Кросс-задачные признаки                            │
│                      │ • Общие паттерны        │                            │
│                      └───────────┬─────────────┘                            │
│                                  │                                           │
│               ┌──────────────────┼──────────────────┐                       │
│               │                  │                  │                       │
│               ▼                  ▼                  ▼                       │
│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│   │ Голова          │ │ Голова          │ │ Голова          │              │
│   │ Направления     │ │ Волатильности   │ │ Режима          │              │
│   │ (маленький MLP) │ │ (маленький MLP) │ │ (маленький MLP) │              │
│   └─────────────────┘ └─────────────────┘ └─────────────────┘              │
│                                                                              │
│   Преимущества:                                                              │
│   • Единый конвейер обучения                                                │
│   • Общие знания между задачами                                             │
│   • Согласованное понимание рынка                                           │
│   • Лучшая обобщающая способность                                           │
│   • Меньшее переобучение                                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Ключевые преимущества для трейдинга

| Аспект | Задаче-специфичный | Задаче-агностический |
|--------|-------------------|---------------------|
| Усилия на разработку | N × моделей | 1 единая модель |
| Обучающие данные | Отдельные для задачи | Общие между задачами |
| Перенос знаний | Отсутствует | Автоматический |
| Согласованность | Независимые предсказания | Когерентные предсказания |
| Адаптация к новой задаче | Полное переобучение | Только голова задачи |
| Поддержка | Высокая | Низкая |
| Обобщение | Специфичное для задачи | Универсальное |

## Теоретические основы

### Универсальное обучение представлений

Основной принцип задаче-агностического обучения — обнаружение представлений, которые захватывают фундаментальную структуру рыночных данных, независимо от какой-либо конкретной последующей задачи.

**Определение**: Задаче-агностическое представление $\phi: X \to Z$ отображает сырые рыночные данные $X$ в латентное пространство $Z$ так, что:

$$\forall \text{задача } T_i: \exists \text{ простой предиктор } h_i: Z \to Y_i$$

где $h_i$ может решить задачу $T_i$, используя только общее представление $Z$.

### Математическая формулировка

**Мультизадачная цель**:

$$\mathcal{L}_{total} = \sum_{i=1}^{N} \lambda_i \mathcal{L}_i(\phi, h_i)$$

где:
- $\phi$ — общий энкодер (задаче-агностический)
- $h_i$ — специфичная для задачи голова для задачи $i$
- $\lambda_i$ — вес задачи
- $\mathcal{L}_i$ — функция потерь для задачи $i$

**Балансировка градиентов**:

Чтобы предотвратить доминирование одной задачи в обучении:

$$\lambda_i = \frac{\overline{L} / L_i}{\sum_j \overline{L} / L_j}$$

где $\overline{L}$ — средние потери по всем задачам.

### Информационно-теоретический взгляд

Хорошее задаче-агностическое представление максимизирует взаимную информацию со всеми задачами:

$$\max_\phi \sum_{i=1}^{N} I(Z; Y_i)$$

при ограничении:

$$I(Z; T) = 0$$

где $T$ — идентификатор задачи. Это гарантирует, что представление не кодирует специфичные для задачи смещения.

```
┌────────────────────────────────────────────────────────────────────────────┐
│                Информационный поток в задаче-агностическом обучении         │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Сырые рыночные данные X                                                  │
│         │                                                                   │
│         │ Содержит: цена, объём, стакан, новости и т.д.                    │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │              Задаче-агностический энкодер φ                         │  │
│   │  ─────────────────────────────────────────────────────────────────  │  │
│   │                                                                      │  │
│   │  Цель: Извлечь информацию, релевантную для ВСЕХ торговых задач     │  │
│   │                                                                      │  │
│   │  Сохраняет:                        Отбрасывает:                      │  │
│   │  • Структуру тренда                • Специфичные для задачи смещения│  │
│   │  • Паттерны волатильности          • Шум, нерелевантный для торговли│  │
│   │  • Микроструктуру рынка            • Ложные корреляции              │  │
│   │  • Кросс-активные связи            • Артефакты переобучения         │  │
│   │  • Характеристики режима                                            │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                                   │
│         ▼                                                                   │
│   Универсальное представление Z                                            │
│         │                                                                   │
│         ├───── Высокая I(Z; Направление цены)                             │
│         ├───── Высокая I(Z; Волатильность)                                │
│         ├───── Высокая I(Z; Режим)                                        │
│         └───── Нулевая I(Z; Идентификатор задачи)                         │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Задаче-агностические архитектуры

### Архитектура 1: Общий энкодер с головами задач

Самый простой и распространённый подход:

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Архитектура с общим энкодером                           │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Вход: Рыночные признаки (OHLCV + Индикаторы + Стакан)                   │
│   ─────────────────────────────────────────────────────                    │
│                           │                                                 │
│                           ▼                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │         Общий энкодер (Заморожен после предобучения)                │  │
│   │  ─────────────────────────────────────────────────────────────────  │  │
│   │                                                                      │  │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │  │
│   │   │ 1D Conv     │──▶│ 1D Conv     │──▶│ 1D Conv     │              │  │
│   │   │ (локальный) │   │ (средний)   │   │ (дальний)   │              │  │
│   │   └─────────────┘   └─────────────┘   └─────────────┘              │  │
│   │         │                 │                 │                       │  │
│   │         └────────────────┬┴─────────────────┘                       │  │
│   │                          ▼                                          │  │
│   │              ┌─────────────────────────┐                            │  │
│   │              │  Multi-Head Attention   │                            │  │
│   │              │ (временные связи)       │                            │  │
│   │              └─────────────────────────┘                            │  │
│   │                          │                                          │  │
│   │                          ▼                                          │  │
│   │              ┌─────────────────────────┐                            │  │
│   │              │  Global Average Pool    │                            │  │
│   │              │  → 256-мерный эмбеддинг │                            │  │
│   │              └─────────────────────────┘                            │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                           │                                                 │
│                           ▼                                                 │
│                  [256-мерное универсальное представление]                   │
│                           │                                                 │
│         ┌─────────────────┼─────────────────┬─────────────────┐            │
│         │                 │                 │                 │            │
│         ▼                 ▼                 ▼                 ▼            │
│   ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐       │
│   │ Голова    │    │ Голова    │    │ Голова    │    │ Голова    │       │
│   │ Направл.  │    │ Волатил.  │    │ Режима    │    │ Доходн.   │       │
│   ├───────────┤    ├───────────┤    ├───────────┤    ├───────────┤       │
│   │ 256→64→3  │    │ 256→64→1  │    │ 256→64→5  │    │ 256→64→1  │       │
│   │ softmax   │    │ ReLU      │    │ softmax   │    │ linear    │       │
│   └───────────┘    └───────────┘    └───────────┘    └───────────┘       │
│         │                 │                 │                 │            │
│         ▼                 ▼                 ▼                 ▼            │
│    [Вверх/Вниз/   [Прогноз      [Бык/Медведь/ [Ожидаемая                │
│     Боковик]       волатильн.]   Боковик/     доходность]               │
│                                  ВысВол/                                 │
│                                  НизВол]                                 │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

### Архитектура 2: Трансформер-энкодер

Использование механизмов внимания для более богатых представлений:

```rust
/// Конфигурация трансформер-энкодера для задаче-агностической модели
#[derive(Debug, Clone)]
pub struct TransformerEncoderConfig {
    /// Размерность входных признаков
    pub input_dim: usize,
    /// Размерность модели (d_model)
    pub model_dim: usize,
    /// Количество голов внимания
    pub num_heads: usize,
    /// Количество слоёв трансформера
    pub num_layers: usize,
    /// Размерность feedforward
    pub ff_dim: usize,
    /// Максимальная длина последовательности
    pub max_seq_len: usize,
    /// Dropout
    pub dropout: f32,
    /// Размерность выходного эмбеддинга
    pub embedding_dim: usize,
}

impl Default for TransformerEncoderConfig {
    fn default() -> Self {
        Self {
            input_dim: 64,
            model_dim: 256,
            num_heads: 8,
            num_layers: 6,
            ff_dim: 1024,
            max_seq_len: 256,
            dropout: 0.1,
            embedding_dim: 256,
        }
    }
}
```

### Архитектура 3: Смесь экспертов (MoE)

Динамическая маршрутизация для разных рыночных условий:

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Архитектура смеси экспертов                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Вход: Рыночные признаки                                                  │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    Сеть маршрутизации                                │  │
│   │  ─────────────────────────────────                                  │  │
│   │  Анализирует вход и определяет веса экспертов                       │  │
│   │                                                                      │  │
│   │  Выход: [w₁=0.1, w₂=0.6, w₃=0.2, w₄=0.1]                           │  │
│   │         (веса суммируются в 1)                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                                   │
│         │ Разреженная маршрутизация (top-k экспертов)                      │
│         │                                                                   │
│   ┌─────┴─────┬─────────────┬─────────────┬─────────────┐                 │
│   │           │             │             │             │                 │
│   ▼           ▼             ▼             ▼             ▼                 │
│ ┌─────┐   ┌─────┐       ┌─────┐       ┌─────┐       ┌─────┐             │
│ │ E₁  │   │ E₂  │       │ E₃  │       │ E₄  │       │ E₅  │             │
│ │Тренд│   │Вола-│       │Возвр│       │Хвост│       │Событ│             │
│ │Экспр│   │тил. │       │к ср.│       │Риск │       │Экспр│             │
│ └──┬──┘   └──┬──┘       └──┬──┘       └──┬──┘       └──┬──┘             │
│    │         │             │             │             │                 │
│    │ ×w₁     │ ×w₂         │ ×w₃         │ ×w₄         │ ×w₅            │
│    │         │             │             │             │                 │
│    └─────────┴──────┬──────┴─────────────┴─────────────┘                 │
│                     │                                                     │
│                     ▼                                                     │
│            Взвешенная сумма выходов экспертов                            │
│                     │                                                     │
│                     ▼                                                     │
│          [Универсальное представление Z]                                  │
│                                                                             │
│   Специализации экспертов:                                                 │
│   • E₁ (Тренд): Сильные направленные движения                             │
│   • E₂ (Волатильность): Периоды высокой неопределённости                  │
│   • E₃ (Возврат к среднему): Паттерны консолидации                        │
│   • E₄ (Хвостовой риск): Экстремальные события                            │
│   • E₅ (Событие): Движения на новостях/отчётах                            │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Универсальное обучение признаков

### Самообучение без учителя

Обучение энкодера без меток с использованием самообучения:

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Задачи самообучения без меток                            │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. МАСКИРОВАННОЕ АВТОКОДИРОВАНИЕ (MAE для временных рядов)              │
│   ───────────────────────────────────────────────────────────              │
│                                                                             │
│   Оригинал:  [p₁] [p₂] [p₃] [p₄] [p₅] [p₆] [p₇] [p₈]                     │
│   Маскиров:  [p₁] [##] [p₃] [##] [##] [p₆] [p₇] [##]  (30% маскировано)  │
│   Задача:    Восстановить маскированные значения                           │
│                                                                             │
│   Это учит модель понимать временные паттерны!                             │
│                                                                             │
│   2. КОНТРАСТНОЕ ОБУЧЕНИЕ                                                   │
│   ─────────────────────────                                                │
│                                                                             │
│   Создание пар:                                                            │
│   • Позитивные: Тот же актив, близкие временные окна (похожие паттерны)   │
│   • Негативные: Разные активы или далёкие временные окна                  │
│                                                                             │
│   ┌─────────┐   похожи     ┌─────────┐                                    │
│   │ BTC t=1 │ ◀──────────▶ │ BTC t=2 │  Притягиваем                       │
│   └─────────┘              └─────────┘                                    │
│        │                                                                   │
│        │ различны                                                          │
│        │                                                                   │
│   ┌─────────┐                                                             │
│   │ ETH t=1 │  Отталкиваем                                                │
│   └─────────┘                                                             │
│                                                                             │
│   3. ПРЕДСКАЗАНИЕ ВРЕМЕННОГО ПОРЯДКА                                       │
│   ──────────────────────────────────                                       │
│                                                                             │
│   Дано: [Окно A] [Окно B]                                                  │
│   Задача: A было до B или после B?                                         │
│                                                                             │
│   Это учит временной причинности!                                          │
│                                                                             │
│   4. ПРЕДСКАЗАНИЕ БУДУЩЕГО (следующий шаг)                                 │
│   ─────────────────────────────────────────                                │
│                                                                             │
│   Дано: [p₁] [p₂] [p₃] [p₄] [p₅]                                          │
│   Задача: Предсказать некоторые статистики [p₆]                            │
│          (не точное значение, а свойства распределения)                    │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Стратегия мультизадачного обучения

### Гармонизация градиентов

Предотвращение конфликтов между задачами при обучении:

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Гармонизация мультизадачных градиентов                   │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Проблема: Градиенты задач могут конфликтовать!                           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Пример конфликтующих градиентов:                                   │  │
│   │                                                                      │  │
│   │  Градиент направления: ▲ (увеличить этот вес)                       │  │
│   │  Градиент волатильн.: ▼ (уменьшить этот вес)                        │  │
│   │                                                                      │  │
│   │  Наивное усреднение: ▲ + ▼ = → (веса почти не двигаются!)           │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Решение: Методы гармонизации градиентов                                  │
│                                                                             │
│   Метод 1: PCGrad (Проекция конфликтующих градиентов)                     │
│   ────────────────────────────────────────────────────                     │
│   Если g₁ · g₂ < 0 (конфликт):                                            │
│       g₁' = g₁ - (g₁·g₂/|g₂|²) × g₂                                       │
│   Проецируем прочь конфликтующую компоненту                                │
│                                                                             │
│   Метод 2: GradNorm (Нормализация градиентов)                             │
│   ────────────────────────────────────────────                             │
│   Динамически корректируем веса задач для баланса амплитуд градиентов     │
│                                                                             │
│   Метод 3: Взвешивание по неопределённости                                 │
│   ─────────────────────────────────────────                                │
│   w_i = 1/(2σ_i²) где σ_i — неопределённость задачи                       │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Применение в трейдинге

### Задаче-агностическая торговая система

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Задаче-агностическая торговая система                    │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ПРИЁМ ДАННЫХ В РЕАЛЬНОМ ВРЕМЕНИ                                          │
│   ────────────────────────────────                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Bybit WebSocket → Конвейер признаков → Буфер признаков             │  │
│   │  • OHLCV (1m, 5m, 15m, 1h, 4h)                                      │  │
│   │  • Стакан (L2 top 20 уровней)                                       │  │
│   │  • Сделки (тик-бай-тик)                                             │  │
│   │  • Ставки финансирования                                            │  │
│   │  • Открытый интерес                                                 │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                           │                                                 │
│                           ▼                                                 │
│   ЗАДАЧЕ-АГНОСТИЧЕСКИЙ ЭНКОДЕР (Предобученный, заморожен)                 │
│   ─────────────────────────────────────────────────────                    │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Рыночные признаки → Универсальный эмбеддинг (256-мерный)           │  │
│   │  Задержка: < 5мс на инференс                                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                           │                                                 │
│                           ▼                                                 │
│   МУЛЬТИЗАДАЧНЫЙ ИНФЕРЕНС (Параллельные головы задач)                     │
│   ────────────────────────────────────────────────────                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │  │
│   │  │ Направление │  │ Волатильн. │  │   Режим     │  │ Доходность│  │  │
│   │  │  68% Вверх  │  │   2.3% ож. │  │ Бык (73%)   │  │   +0.5%   │  │  │
│   │  │  22% Вниз   │  │            │  │             │  │ ожидается │  │  │
│   │  │  10% Боков. │  │            │  │             │  │           │  │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                           │                                                 │
│                           ▼                                                 │
│   СЛИЯНИЕ РЕШЕНИЙ (Объединение всех выходов задач)                        │
│   ────────────────────────────────────────────────                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Проверка согласованности:                                          │  │
│   │  • Направл.=Вверх + Режим=Бык + Доходн.=Полож. → СОГЛАСОВАНО ✓     │  │
│   │  • Направл.=Вверх + Режим=Медведь → КОНФЛИКТ! → Снижаем уверенность│  │
│   │                                                                      │  │
│   │  Оценка риска:                                                       │  │
│   │  • Прогноз волатильности определяет размер позиции                  │  │
│   │  • Режим определяет уровни стоп-лосс/тейк-профит                    │  │
│   │                                                                      │  │
│   │  Итоговый сигнал:                                                    │  │
│   │  • Действие: ЛОНГ                                                   │  │
│   │  • Уверенность: 72% (согласованные предсказания)                    │  │
│   │  • Размер: 1.5% от капитала (умеренная волатильность)               │  │
│   │  • Стоп: -1.5% (бычий режим, плотный стоп)                          │  │
│   │  • Цель: +2.0% (ожидаемая доходность + буфер)                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                           │                                                 │
│                           ▼                                                 │
│   ИСПОЛНЕНИЕ ОРДЕРОВ                                                       │
│   ───────────────────                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Bybit API → Рыночный/лимитный ордер → Мониторинг позиции           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Интеграция с Bybit

### Конвейер сбора данных

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Конвейер данных Bybit                                    │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ИСТОЧНИКИ ДАННЫХ ДЛЯ ЗАДАЧЕ-АГНОСТИЧЕСКОГО ОБУЧЕНИЯ                     │
│   ───────────────────────────────────────────────────                      │
│                                                                             │
│   1. ИСТОРИЧЕСКИЕ ДАННЫЕ (Обучение)                                        │
│   ─────────────────────────────────                                        │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Эндпоинт: GET /v5/market/kline                                     │  │
│   │  Символы: BTCUSDT, ETHUSDT, SOLUSDT, ... (топ 50 по объёму)        │  │
│   │  Интервалы: 1m, 5m, 15m, 1h, 4h, 1d                                 │  │
│   │  История: 2 года                                                     │  │
│   │                                                                      │  │
│   │  Генерация меток для задач:                                         │  │
│   │  ┌─────────────────────────────────────────────────────────────┐    │  │
│   │  │ Направление: На основе знака будущей доходности             │    │  │
│   │  │ Волатильность: Реализованная волатильность за следующие периоды   │  │
│   │  │ Режим: HMM кластеризация по доходности/волатильности        │    │  │
│   │  │ Доходность: Фактическая будущая доходность (непрерывная)    │    │  │
│   │  └─────────────────────────────────────────────────────────────┘    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   2. ДАННЫЕ В РЕАЛЬНОМ ВРЕМЕНИ (Инференс)                                  │
│   ────────────────────────────────────────                                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  WebSocket: wss://stream.bybit.com/v5/public/linear                 │  │
│   │                                                                      │  │
│   │  Подписки:                                                           │  │
│   │  • kline.1.BTCUSDT (1-минутные свечи)                               │  │
│   │  • orderbook.50.BTCUSDT (L2 стакан)                                 │  │
│   │  • publicTrade.BTCUSDT (тиковые сделки)                             │  │
│   │  • tickers.BTCUSDT (рыночная статистика)                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Реализация

### Структура модуля

```
87_task_agnostic_trading/
├── Cargo.toml
├── README.md                     # Документация (английский)
├── README.ru.md                  # Русский перевод
├── readme.simple.md              # Упрощённое объяснение
├── readme.simple.ru.md           # Упрощённое объяснение (русский)
├── src/
│   ├── lib.rs                    # Корень библиотеки
│   ├── config.rs                 # Типы конфигурации
│   ├── encoder/
│   │   ├── mod.rs               # Модуль энкодера
│   │   ├── transformer.rs       # Трансформер-энкодер
│   │   ├── cnn.rs               # CNN-энкодер
│   │   └── moe.rs               # Смесь экспертов
│   ├── tasks/
│   │   ├── mod.rs               # Модуль задач
│   │   ├── direction.rs         # Предсказание направления
│   │   ├── volatility.rs        # Прогноз волатильности
│   │   ├── regime.rs            # Определение режима
│   │   └── returns.rs           # Предсказание доходности
│   ├── training/
│   │   ├── mod.rs               # Модуль обучения
│   │   ├── multitask.rs         # Мультизадачное обучение
│   │   ├── curriculum.rs        # Курриккулум задач
│   │   └── pretraining.rs       # Предобучение
│   ├── fusion/
│   │   ├── mod.rs               # Модуль слияния
│   │   └── decision.rs          # Слияние решений
│   ├── data/
│   │   ├── mod.rs               # Модуль данных
│   │   ├── bybit.rs             # API клиент Bybit
│   │   ├── features.rs          # Инженерия признаков
│   │   └── dataset.rs           # Обработка датасета
│   └── trading/
│       ├── mod.rs               # Модуль торговли
│       ├── strategy.rs          # Торговая стратегия
│       └── risk.rs              # Управление рисками
├── examples/
│   ├── train_encoder.rs         # Обучение энкодера
│   ├── multi_task_inference.rs  # Мультизадачный инференс
│   ├── bybit_trading.rs         # Торговля с Bybit
│   └── backtest.rs              # Бэктестинг
├── python/
│   ├── task_agnostic_model.py   # PyTorch реализация
│   ├── train.py                 # Скрипт обучения
│   ├── evaluate.py              # Скрипт оценки
│   └── requirements.txt         # Python зависимости
└── tests/
    ├── integration.rs           # Интеграционные тесты
    └── unit_tests.rs            # Юнит-тесты
```

## Управление рисками

### Мультизадачная оценка риска

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    Мультизадачная оценка риска                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. ОЦЕНКА СОГЛАСОВАННОСТИ ЗАДАЧ                                          │
│   ────────────────────────────────                                         │
│                                                                             │
│   Когда задачи согласованы → Выше уверенность, больше позиции             │
│   Когда задачи конфликтуют → Ниже уверенность, меньше позиции или без сделки
│                                                                             │
│   Матрица согласованности:                                                 │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │              │ Направл. │ Волатил. │ Режим  │ Доходн. │ Оценка   │   │
│   │──────────────┼──────────┼──────────┼────────┼─────────┼──────────│   │
│   │ Сценарий 1   │   ВВЕРХ  │   НИЗКАЯ │  БЫК   │  +0.5%  │   0.95   │   │
│   │ (Все согл.)  │          │          │        │         │  СДЕЛКА  │   │
│   │──────────────┼──────────┼──────────┼────────┼─────────┼──────────│   │
│   │ Сценарий 2   │   ВВЕРХ  │  ВЫСОКАЯ │  БЫК   │  +0.3%  │   0.70   │   │
│   │ (Вол. пред.) │          │          │        │         │ ОСТОРОЖН │   │
│   │──────────────┼──────────┼──────────┼────────┼─────────┼──────────│   │
│   │ Сценарий 3   │   ВВЕРХ  │  ВЫСОКАЯ │ МЕДВЕДЬ│  -0.2%  │   0.30   │   │
│   │ (Конфликт)   │          │          │        │         │БЕЗ СДЕЛКИ│   │
│   └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   2. ДИНАМИЧЕСКИЙ РАЗМЕР ПОЗИЦИИ                                           │
│   ──────────────────────────────                                           │
│                                                                             │
│   Размер позиции = База × Уверенность × (1 / Ранг_волатильности)          │
│                                                                             │
│   3. СТОП-ЛОСС С УЧЁТОМ РЕЖИМА                                             │
│   ─────────────────────────────                                            │
│                                                                             │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │  Режим           │  Стоп-лосс │  Тейк-профит │  Обоснование       │   │
│   │──────────────────┼────────────┼──────────────┼────────────────────│   │
│   │  Бык             │  -1.5%     │  +3.0%       │  Держим тренд      │   │
│   │  Медведь         │  -1.5%     │  +3.0%       │  Ловим движение    │   │
│   │  Боковик         │  -1.0%     │  +1.5%       │  Узкий диапазон    │   │
│   │  Высокая волат.  │  -2.5%     │  +4.0%       │  Широкие стопы     │   │
│   │  Низкая волат.   │  -1.0%     │  +1.5%       │  Плотный контроль  │   │
│   └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

## Метрики производительности

### Метрики оценки модели

| Метрика | Описание | Цель |
|---------|----------|------|
| **Мультизадачная точность** | Средняя точность по всем задачам классификации | > 65% |
| **Точность направления** | Точность предсказания направления цены | > 60% |
| **Точность режима** | Точность определения режима рынка | > 70% |
| **RMSE волатильности** | Среднеквадратичная ошибка прогноза волатильности | < 0.02 |
| **Корреляция доходности** | Корреляция предсказанной и фактической доходности | > 0.3 |
| **Перенос на задачу** | Производительность при добавлении новой задачи | > 90% от обучения с нуля |
| **Оценка согласованности** | Как часто предсказания задач совпадают | > 70% |

### Метрики торговой производительности

| Метрика | Описание | Цель |
|---------|----------|------|
| **Коэффициент Шарпа** | Доходность с учётом риска | > 2.0 |
| **Коэффициент Сортино** | Доходность с учётом риска просадки | > 2.5 |
| **Макс. просадка** | Наибольшее падение от пика до дна | < 15% |
| **Процент выигрышных** | Процент прибыльных сделок | > 55% |
| **Профит-фактор** | Валовая прибыль / Валовый убыток | > 1.5 |
| **Коэффициент Калмара** | Годовая доходность / Макс. просадка | > 1.0 |

---

## Ссылки

1. **Model-Agnostic Meta-Learning for Natural Language Understanding Tasks in Finance**
   - URL: https://arxiv.org/abs/2303.02841
   - Год: 2023

2. **Trading in Fast-Changing Markets with Meta-Reinforcement Learning**
   - MAML-метод торговли для множества задач
   - Год: 2024

3. **Multi-Task Learning in Deep Neural Networks: A Survey**
   - Комплексный обзор мультизадачных архитектур
   - URL: https://arxiv.org/abs/2009.09796

4. **Gradient Surgery for Multi-Task Learning**
   - Метод PCGrad для обработки конфликтов градиентов
   - URL: https://arxiv.org/abs/2001.06782

5. **Adaptive Event-Driven Labeling with Meta-Learning for Financial Time Series**
   - Многомасштабный временной анализ с MAML
   - Год: 2025

---

## Следующие шаги

- [Простое объяснение](readme.simple.md) - Версия для начинающих
- [Английская версия](README.md) - English version
- [Примеры](examples/) - Рабочий код на Rust
- [Python реализация](python/) - Эталонная реализация на PyTorch

---

*Глава 87 книги "Машинное обучение для трейдинга"*

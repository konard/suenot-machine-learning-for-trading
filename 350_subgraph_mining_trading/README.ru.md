# Глава 350: Майнинг Подграфов для Трейдинга — Обнаружение Скрытых Паттернов в Финансовых Сетях

## Обзор

Финансовые рынки образуют сложные сети: активы связаны корреляциями, компании — цепочками поставок, трейдеры — потоком ордеров. **Майнинг подграфов** обнаруживает повторяющиеся структурные паттерны (мотивы) в этих сетях, которые могут предсказывать движения цен, смены режимов и торговые возможности.

Традиционный анализ графов рассматривает признаки на уровне узлов или рёбер. Майнинг подграфов идёт глубже — он находит **частые подструктуры**, появляющиеся в графе или во времени, раскрывая скрытую рыночную динамику, невидимую стандартными методами.

## Торговая Стратегия

**Основная идея:** Построить динамические финансовые графы из рыночных данных и добыть частые паттерны подграфов. Когда появляются определённые паттерны, они сигнализируют о торговых возможностях:

1. **Корреляционные сети:** Активы — узлы, корреляции — рёбра. Майнинг подграфов выявляет ротации секторов и паттерны заражения
2. **Графы потока ордеров:** Трейдеры/адреса — узлы, транзакции — рёбра. Паттерны показывают накопление, распределение, движения китов
3. **Временные графы:** Одна сеть во времени. Изменения паттернов сигнализируют о смене режимов

**Преимущество:** Паттерны подграфов захватывают зависимости высокого порядка, которые пропускают корреляционные матрицы и попарный анализ. Треугольник сильных корреляций имеет иное значение, чем цепочка.

## Ключевые Концепции

### Что такое Подграф?

Подграф — это меньший граф, содержащийся внутри большего графа. Например, в сети из 100 криптовалют, связанных корреляциями:
- **Треугольник** (3 узла, 3 ребра) может представлять сектор (BTC-ETH-BNB)
- **Звезда** (1 хаб, соединённый со многими) может представлять лидера рынка
- **Клика** (полносвязная подгруппа) представляет высококоррелированные активы

### Алгоритмы Майнинга Подграфов

| Алгоритм | Тип | Лучше всего для |
|----------|-----|-----------------|
| gSpan | Частые подграфы | Поиск общих паттернов |
| FSG | Частые подграфы | Разреженные графы |
| SUBDUE | На основе сжатия | Поиск информативных паттернов |
| GraMi | Приближённый | Большие графы |
| Нейронный (GNN) | На основе обучения | Задачи предсказания |

### Построение Финансовых Графов

```
Рыночные данные → Построение графа → Майнинг подграфов → Торговые сигналы
       ↓                 ↓                   ↓                ↓
    OHLCV          Корреляция/Поток      Паттерны        Вход/Выход
    Order Book     Пороговые рёбра       Частота         Размер позиции
    Транзакции     Динамические          Поддержка       Риск-менеджмент
                   обновления
```

## Техническая Спецификация

### Типы Графов для Трейдинга

#### 1. Корреляционная Сеть
```
Узлы: Активы (криптовалюты)
Рёбра: Корреляция > порога (напр., 0.7)
Вес ребра: Сила корреляции
Временной: Скользящее окно (напр., 24ч, 7д)
```

#### 2. Граф Потока Ордеров
```
Узлы: Адреса кошельков / ID трейдеров
Рёбра: Транзакции между узлами
Вес ребра: Объём / Частота
Временной: Временные метки транзакций
```

#### 3. Сеть Опережения-Отставания
```
Узлы: Активы
Рёбра: Причинность Грейнджера / Transfer entropy
Вес ребра: Предсказательная сила
Направление: Лидер → Последователь
```

### Типы Паттернов Подграфов

| Паттерн | Структура | Торговый сигнал |
|---------|-----------|-----------------|
| Треугольник | 3 связанных актива | Сила сектора |
| Звезда | Хаб + лучи | Влияние лидера рынка |
| Цепочка | Линейный путь | Каскад информации |
| Клика-4+ | Полносвязные 4+ | Сильный режим |
| Двудольный | Две группы | Ротация секторов |

### Алгоритм Майнинга: gSpan для Финансовых Сетей

```
1. Построить граф G из рыночных данных
2. Найти частые рёбра (support > min_sup)
3. Расширить паттерны используя DFS-код
4. Отсечь нечастые паттерны
5. Вывести частые паттерны подграфов
```

### Генерация Сигналов

```
Для каждого торгового периода:
    1. Построить текущий граф G_t из последних данных
    2. Сопоставить известные паттерны с G_t
    3. Вычислить оценки паттернов:
       - Изменение частоты (появление нового паттерна)
       - Полнота (частичное vs полное совпадение)
       - Центральность (позиция паттерна в сети)
    4. Сгенерировать сигналы на основе семантики паттернов
```

## Архитектура Реализации (Rust)

```
src/
├── lib.rs              # Точка входа библиотеки
├── graph/
│   ├── mod.rs          # Модуль графа
│   ├── types.rs        # Типы Node, Edge, Graph
│   ├── builder.rs      # Построение графа из данных
│   └── algorithms.rs   # Алгоритмы на графах
├── mining/
│   ├── mod.rs          # Модуль майнинга
│   ├── gspan.rs        # Алгоритм gSpan
│   ├── pattern.rs      # Представление паттернов
│   └── matcher.rs      # Сопоставление паттернов
├── trading/
│   ├── mod.rs          # Модуль трейдинга
│   ├── signals.rs      # Генерация сигналов
│   ├── strategy.rs     # Торговая стратегия
│   └── backtest.rs     # Движок бэктестинга
├── data/
│   ├── mod.rs          # Модуль данных
│   ├── bybit.rs        # Клиент API Bybit
│   ├── types.rs        # Типы рыночных данных
│   └── cache.rs        # Кеширование данных
└── utils/
    ├── mod.rs          # Утилиты
    ├── stats.rs        # Статистические функции
    └── config.rs       # Конфигурация
```

## Ключевые Метрики

### Качество Паттернов
- **Поддержка (Support):** Частота появления паттерна
- **Значимость:** Статистическая значимость vs случайный
- **Стабильность:** Устойчивость во временных окнах
- **Предсказательная сила:** Корреляция с будущей доходностью

### Торговая Эффективность
- **Sharpe Ratio:** Доходность с поправкой на риск
- **Sortino Ratio:** Доходность с поправкой на падение
- **Максимальная просадка:** Наибольшее снижение от пика
- **Win Rate:** Процент прибыльных сделок
- **Profit Factor:** Валовая прибыль / Валовой убыток

## Детали Алгоритмов

### Построение Графа из Крипто-Данных

```
Вход: OHLCV данные для N криптовалют
Параметры: window_size, correlation_threshold

1. Вычислить доходности: r_i = (close_t - close_{t-1}) / close_{t-1}
2. Рассчитать матрицу корреляций: C = corr(returns, window=window_size)
3. Построить матрицу смежности:
   A[i,j] = 1 если C[i,j] > threshold
   A[i,j] = 0 иначе
4. Создать граф G = (V, E) где:
   V = {asset_1, ..., asset_N}
   E = {(i,j) : A[i,j] = 1}
```

### Основной Алгоритм gSpan

```
Процедура gSpan(G, min_sup):
    S = ∅  // частые подграфы
    для каждого частого ребра e в G:
        Паттерн p = {e}
        gSpan-Extend(p, G, min_sup, S)
    вернуть S

Процедура gSpan-Extend(p, G, min_sup, S):
    если p замкнут:  // нет частых расширений
        S = S ∪ {p}
        вернуть

    для каждого правого расширения e паттерна p:
        p' = p ∪ {e}
        если support(p', G) >= min_sup:
            gSpan-Extend(p', G, min_sup, S)
```

### Логика Торговых Сигналов

```
Генерация сигналов:
1. БЫЧЬИ паттерны:
   - Формирование нового треугольника в растущих активах
   - Паттерн звезды с сильным хабом (лидер рынка)
   - Расширение клики (больше активов присоединяется к группе)

2. МЕДВЕЖЬИ паттерны:
   - Разрушение треугольника (удаление ребра)
   - Коллапс звезды (ослабление хаба)
   - Фрагментация клики

3. НЕЙТРАЛЬНЫЕ / ОСТОРОЖНОСТЬ:
   - Быстрые изменения паттернов (неопределённость режима)
   - Увеличение изолированных узлов (декорреляция)
```

## Интеграция с Bybit

### Источники Данных
- **Спот-рынок:** BTCUSDT, ETHUSDT и 50+ пар
- **Бессрочные фьючерсы:** Ставки финансирования, открытый интерес
- **Стакан ордеров:** Снимки глубины (L2/L3)
- **Сделки:** Индивидуальные транзакции с временными метками

### Используемые API Эндпоинты
```
GET /v5/market/kline          # OHLCV свечи
GET /v5/market/tickers        # Текущие цены
GET /v5/market/orderbook      # Глубина стакана
GET /v5/market/recent-trade   # Последние сделки
```

## Ожидаемые Результаты

1. **Пайплайн построения графов:** Построение корреляционных/потоковых графов из данных Bybit
2. **Движок майнинга:** Эффективное обнаружение паттернов подграфов
3. **Каталог паттернов:** Библиотека значимых торговых паттернов
4. **Генератор сигналов:** Сопоставление паттернов и сигналы в реальном времени
5. **Фреймворк бэктеста:** Валидация исторической эффективности
6. **Готовность к live-трейдингу:** Production-качество реализации на Rust

## Ссылки

### Научные Статьи
- [gSpan: Graph-Based Substructure Pattern Mining](https://www.cs.ucsb.edu/~xyan/papers/gSpan-short.pdf) - Yan & Han, 2002
- [Subgraph Neural Networks](https://arxiv.org/abs/2006.10538) - Alsentzer et al., 2020
- [Network Motifs in Financial Markets](https://arxiv.org/abs/1209.2927) - Pozzi et al., 2012
- [Graph-based Stock Market Analysis](https://arxiv.org/abs/2004.00388) - Chen et al., 2020

### Технические Ресурсы
- [Документация Bybit API](https://bybit-exchange.github.io/docs/)
- [petgraph (Rust Graph Library)](https://docs.rs/petgraph/)
- [Обзор Graph Mining](https://arxiv.org/abs/2005.03675)

## Уровень Сложности

Эксперт

**Предварительные требования:**
- Основы теории графов
- Проектирование алгоритмов (DFS, сопоставление паттернов)
- Анализ временных рядов
- Программирование на Rust
- Механика криптовалютных рынков
